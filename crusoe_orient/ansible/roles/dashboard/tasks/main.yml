- name: Install nvm
  shell: >
    curl https://raw.githubusercontent.com/creationix/nvm/v0.7.0/install.sh | sh
    creates={{ ansible_env.HOME }}/.nvm/nvm.sh

- name: Install node and set version
  shell: >
    /bin/bash -c "source ~/.nvm/nvm.sh && nvm install {{ node_version }} && nvm alias default {{ node_version }}"
    creates={{ ansible_env.HOME }}/.nvm/alias

- name: Create a symlink to node and npm for ansible
  file:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    state: link
  loop:
    - {src: "{{ nvm_bin }}/node", dest: "/usr/bin/node"}
    - {src: "{{ nvm_bin }}/npm", dest: "/usr/bin/npm"}
  become: yes

# Install nginx web server
- name: Install nginx
  apt:
    name: nginx
    state: present
    update_cache: yes
  become: yes

# Start nginx web server
- name: start nginx
  service:
    name: nginx
    state: started

# Copy environment file where REST API urls are defined
- name: Copy environment file
  template:
    src: environment.prod.ts.j2
    dest: '{{ dashboard_folder }}/src/environments/environment.prod.ts'


# Install Dashboard dependencies
- name: Install Dashboard dependencies
  npm:
    path: '{{ dashboard_folder }}'

# Build application using Angular-CLI
- name: Build application
  command: 'npm run build'
  args:
    chdir: '{{ dashboard_folder }}'
    creates: '{{ dashboard_folder }}/dist'

# Copy nginx config
- name: Copy Nginx conf file
  template:
    src: 'dashboard.conf'
    dest: /etc/nginx/nginx.conf
  become: yes

# Create folder for Dashboard files in /var/www/
- name: Create dashboard folder in /var/www/
  command: 'mkdir /var/www/dashboard'
  become: yes

# Copy Dashboard files
- name: Copy dashboard files
  command: 'cp -a {{ dashboard_folder }}/dist/. /var/www/dashboard/'
  become: yes

# Reload nginx
- name: Reload nginx
  service:
    name: nginx
    state: reloaded
  become: yes
