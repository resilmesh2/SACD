{"version":3,"file":"sentinel-common-filter-services.mjs","sources":["../../../projects/sentinel-common/filter-services/src/filter.service.ts","../../../projects/sentinel-common/filter-services/src/filter-chips.service.ts","../../../projects/sentinel-common/filter-services/src/query-param-filter.service.ts","../../../projects/sentinel-common/filter-services/src/sentinel-common-filter-services.ts"],"sourcesContent":["import equal from 'fast-deep-equal/es6';\nimport { BehaviorSubject, Observable } from 'rxjs';\nimport { distinctUntilChanged, map, shareReplay, tap } from 'rxjs/operators';\nimport { isArray } from '@sentinel/common/utils';\n\nexport abstract class FilterService<Filter> {\n  readonly EMPTY_FILTER: Filter;\n  protected filterLocalStateSubject$: BehaviorSubject<Filter>;\n  protected filterSubject$: BehaviorSubject<Filter>;\n  filterLocalState$: Observable<Filter>;\n  filter$: Observable<Filter>;\n  activeFiltersCount$: Observable<number>;\n  isEmpty$: Observable<boolean>;\n  /*\n  Keys which are ignored in evaluation of isEmpty filter\n   */\n  ignoredKeys: Array<keyof Filter>;\n  ignoredActiveFilterKeys: Array<keyof Filter>;\n\n  protected constructor(\n    ignoredKeys: Array<keyof Filter> = [],\n    ignoredActiveFilterKeys: Array<keyof Filter> = ignoredKeys,\n  ) {\n    this.ignoredKeys = ignoredKeys;\n    this.ignoredActiveFilterKeys = ignoredActiveFilterKeys;\n    this.EMPTY_FILTER = this.createEmptyFilter();\n    this.filterLocalStateSubject$ = new BehaviorSubject<Filter>(this.EMPTY_FILTER);\n    this.filterSubject$ = new BehaviorSubject<Filter>(this.filterLocalStateSubject$.getValue());\n    this.filterLocalState$ = this.filterLocalStateSubject$.asObservable().pipe(\n      distinctUntilChanged((prev, curr) => equal(prev, curr)),\n      shareReplay({ refCount: true }),\n    );\n    this.filter$ = this.filterSubject$.asObservable().pipe(\n      distinctUntilChanged((prev, curr) => equal(prev, curr)),\n      tap((filter) => this.filterLocalStateSubject$.next(filter), shareReplay({ refCount: true })),\n    );\n    this.isEmpty$ = this.filter$.pipe(\n      map((filter) => this.areFilterKeysEqual(filter, this.EMPTY_FILTER)),\n      distinctUntilChanged(),\n    );\n    this.activeFiltersCount$ = this.filterLocalState$.pipe(\n      map((filter) => this.calculateActiveFiltersCount(filter)),\n      distinctUntilChanged(),\n    );\n  }\n\n  get(): Filter {\n    return this.filterSubject$.getValue();\n  }\n\n  update(filter: Partial<Filter>): void {\n    const curr = { ...this.filterLocalStateSubject$.getValue() };\n    this.filterLocalStateSubject$.next({ ...curr, ...filter });\n  }\n\n  updateAndSubmit(filter: Partial<Filter>): void {\n    this.update(filter);\n    this.submit();\n  }\n\n  submit(): void {\n    this.filterSubject$.next(this.filterLocalStateSubject$.getValue());\n  }\n\n  clear(): void {\n    const currFilter = this.get();\n    const emptyFilter = { ...this.EMPTY_FILTER };\n    this.ignoredKeys.forEach((ignoredKey) => {\n      if (currFilter[ignoredKey] !== undefined && currFilter[ignoredKey] !== null) {\n        emptyFilter[ignoredKey] = currFilter[ignoredKey];\n      }\n    });\n    this.filterLocalStateSubject$.next(emptyFilter);\n    this.submit();\n  }\n\n  set(filter: Filter): void {\n    this.filterLocalStateSubject$.next(filter);\n  }\n\n  protected abstract createEmptyFilter(): Filter;\n\n  protected areFilterKeysEqual(prev: Filter, curr: Filter, compareIgnoredKeys = false): boolean {\n    const prevCopy = { ...prev };\n    const currCopy = { ...curr };\n    if (!compareIgnoredKeys) {\n      this.ignoredKeys.forEach((ignoredKey) => {\n        delete prevCopy[ignoredKey];\n        delete currCopy[ignoredKey];\n      });\n    }\n    return equal(currCopy, prevCopy);\n  }\n\n  protected calculateActiveFiltersCount(filter: Filter): number {\n    if (typeof filter === 'object') {\n      let count = 0;\n      const narrowedFilter = filter as { [key: string]: unknown };\n      Object.keys(narrowedFilter).forEach((key) => {\n        if (\n          !this.ignoredActiveFilterKeys.includes(key as keyof Filter) &&\n          narrowedFilter[key] !== undefined &&\n          narrowedFilter[key] !== null &&\n          narrowedFilter[key] !== '' &&\n          (!isArray(narrowedFilter[key]) || (narrowedFilter[key] as Array<unknown>).length > 0)\n        ) {\n          count++;\n        }\n      });\n      return count;\n    } else {\n      return 0;\n    }\n  }\n}\n","import { Observable } from 'rxjs';\nimport { map } from 'rxjs/operators';\nimport { FilterService } from './filter.service';\nimport { FilterChip } from '@sentinel/common/filter';\n\nexport abstract class FilterChipsService<Filter> {\n  chips$: Observable<FilterChip[]>;\n\n  protected constructor(protected filterService: FilterService<Filter>) {\n    this.chips$ = this.filterService.filter$.pipe(map((filter) => this.createChips(filter)));\n  }\n  abstract removeChip(removedChip: FilterChip): void;\n  protected abstract createChips(filter?: Filter): FilterChip[];\n}\n","import { ActivatedRoute, Data, ParamMap, Params } from '@angular/router';\nimport {\n  deslugify,\n  deslugifyTimestamp,\n  isArray,\n  isDate,\n  Optional,\n  QueryParamsNavigationQueueService,\n  slugify,\n  slugifyDate,\n} from '@sentinel/common/utils';\nimport { combineLatest, from, merge, Observable } from 'rxjs';\nimport { concatMap, distinctUntilChanged, map, shareReplay, skip, tap } from 'rxjs/operators';\nimport { FilterService } from './filter.service';\nimport { inject } from '@angular/core';\n\nexport abstract class QueryParamFilterService<Filter extends object> extends FilterService<Filter> {\n  filter$: Observable<Filter>;\n  protected queryParamsQueueService = inject(QueryParamsNavigationQueueService);\n  protected activatedRoute = inject(ActivatedRoute);\n\n  protected constructor(\n    ignoredKeys: Array<keyof Filter> = [],\n    ignoredActiveFilterKeys: Array<keyof Filter> = ignoredKeys,\n  ) {\n    super(ignoredKeys, ignoredActiveFilterKeys);\n    this.filter$ = this.createFilterObservable();\n  }\n  protected abstract createFilterFromRoute(queryParamMap: ParamMap, paramMap: ParamMap, data: Data): Observable<Filter>;\n\n  protected toQueryParams(filter: Filter): Params {\n    const params: Params = {};\n    const entries = Object.entries(filter);\n    entries\n      .filter((entry) => !this.ignoredKeys.map((key) => key.toString()).includes(entry[0]))\n      .forEach((entry) => {\n        if (isDate(entry[1])) {\n          params[entry[0]] = this.slugifyDate(entry[1]);\n        } else if (isArray(entry[1])) {\n          params[entry[0]] = entry[1].map((entry) => this.slugify(entry?.toString()));\n        } else {\n          params[entry[0]] = this.slugify(entry[1]?.toString());\n        }\n      });\n    return params;\n  }\n\n  protected updateQueryParams(filter: Filter): Observable<boolean> {\n    return from(this.queryParamsQueueService.enqueue(this.toQueryParams(filter)));\n  }\n\n  protected slugify(value: string | undefined | null): Optional<string> {\n    return slugify(value);\n  }\n  protected slugifyDate(value: Date): number {\n    return slugifyDate(value);\n  }\n\n  protected deslugify(value: string | undefined | null): Optional<string> {\n    return deslugify(value);\n  }\n\n  protected deslugifyTimestamp(value: string | undefined | null): Optional<Date> {\n    return deslugifyTimestamp(value);\n  }\n\n  protected getParamValue(paramMap: ParamMap, key: keyof Filter): string | null {\n    return paramMap.get(key.toString());\n  }\n\n  private createFilterObservable(): Observable<Filter> {\n    const fromRoute$ = this.fromRoute().pipe(tap((filter) => this.updateAndSubmit(filter)));\n    const fromSubject$ = this.createFilterSubjectObservable();\n\n    return merge(fromSubject$, fromRoute$).pipe(\n      distinctUntilChanged((prev, curr) => this.areFilterKeysEqual(prev, curr, true)),\n      concatMap((filter) => this.updateQueryParams(filter).pipe(map(() => filter))),\n      shareReplay({ refCount: true }),\n    );\n  }\n\n  private createFilterSubjectObservable(): Observable<Filter> {\n    // skip subject init from route\n    return this.filterSubject$.asObservable().pipe(shareReplay({ refCount: true }), skip(1));\n  }\n\n  private fromRoute(): Observable<Filter> {\n    return combineLatest([\n      this.activatedRoute.queryParamMap,\n      this.activatedRoute.paramMap,\n      this.activatedRoute.data,\n    ]).pipe(\n      concatMap((routeAsyncAttrs) =>\n        this.createFilterFromRoute(routeAsyncAttrs[0], routeAsyncAttrs[1], routeAsyncAttrs[2]),\n      ),\n    );\n  }\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public_api';\n"],"names":[],"mappings":"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"}