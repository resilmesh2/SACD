import { Inject, Injectable, Optional } from '@angular/core';
import equal from 'fast-deep-equal/es6';
import { from } from 'rxjs';
import { concatMap, distinctUntilChanged, map, shareReplay, take } from 'rxjs/operators';
import { INIT_SORT_TOKEN } from './order-token';
import { SortService } from './sort.service';
import { toQueryParams } from '@sentinel/common/utils';
import * as i0 from "@angular/core";
import * as i1 from "@sentinel/common/utils";
import * as i2 from "@angular/router";
export class QueryParamSortService extends SortService {
    constructor(queryParamsQueueService, activatedRoute, initSort) {
        super(initSort);
        this.queryParamsQueueService = queryParamsQueueService;
        this.activatedRoute = activatedRoute;
        this.initSort = initSort;
        this.sort$ = this.createSortObservable();
    }
    updateQueryParams(sort) {
        return from(this.queryParamsQueueService.enqueue(toQueryParams(sort)));
    }
    createSortObservable() {
        return this.fromRoute().pipe(take(1), concatMap(() => this.sortSubject$), distinctUntilChanged((prev, curr) => equal(prev, curr)), concatMap((sort) => this.updateQueryParams(sort).pipe(map(() => sort))), shareReplay({ refCount: true }));
    }
    fromRoute() {
        return this.activatedRoute.queryParamMap.pipe(take(1), map((paramMap) => this.sortFromParamMap(paramMap)));
    }
    sortFromParamMap(paramMap) {
        const sort = paramMap.get('sort');
        const sortDirStr = paramMap.get('sortDir');
        if (sort !== null && sortDirStr !== null) {
            const sortDir = sortDirStr === 'asc' ? 'asc' : 'desc';
            return { sort, sortDir };
        }
        return this.INIT_SORT;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.0", ngImport: i0, type: QueryParamSortService, deps: [{ token: i1.QueryParamsNavigationQueueService }, { token: i2.ActivatedRoute }, { token: INIT_SORT_TOKEN, optional: true }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.0.0", ngImport: i0, type: QueryParamSortService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.0", ngImport: i0, type: QueryParamSortService, decorators: [{
            type: Injectable
        }], ctorParameters: () => [{ type: i1.QueryParamsNavigationQueueService }, { type: i2.ActivatedRoute }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [INIT_SORT_TOKEN]
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktcGFyYW0tc29ydC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvc2VudGluZWwtY29tbW9uL3NvcnQtc2VydmljZXMvc3JjL3F1ZXJ5LXBhcmFtLXNvcnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFN0QsT0FBTyxLQUFLLE1BQU0scUJBQXFCLENBQUM7QUFDeEMsT0FBTyxFQUFFLElBQUksRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUN4QyxPQUFPLEVBQUUsU0FBUyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekYsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNoRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFN0MsT0FBTyxFQUFxQyxhQUFhLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQzs7OztBQUcxRixNQUFNLE9BQU8scUJBQXNCLFNBQVEsV0FBVztJQUNwRCxZQUNZLHVCQUEwRCxFQUM1RCxjQUE4QixFQUNrQixRQUFvQjtRQUU1RSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7UUFKTiw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQW1DO1FBQzVELG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUNrQixhQUFRLEdBQVIsUUFBUSxDQUFZO1FBRzVFLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7SUFDM0MsQ0FBQztJQUVTLGlCQUFpQixDQUFDLElBQWU7UUFDekMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQVksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3BGLENBQUM7SUFFTyxvQkFBb0I7UUFDMUIsT0FBTyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUMsSUFBSSxDQUMxQixJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQ1AsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsRUFDbEMsb0JBQW9CLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLEVBQ3ZELFNBQVMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUN2RSxXQUFXLENBQUMsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FDaEMsQ0FBQztJQUNKLENBQUM7SUFFTyxTQUFTO1FBQ2YsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQzNDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFDUCxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUNuRCxDQUFDO0lBQ0osQ0FBQztJQUVPLGdCQUFnQixDQUFDLFFBQWtCO1FBQ3pDLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbEMsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUMzQyxJQUFJLElBQUksS0FBSyxJQUFJLElBQUksVUFBVSxLQUFLLElBQUksRUFBRSxDQUFDO1lBQ3pDLE1BQU0sT0FBTyxHQUFHLFVBQVUsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1lBQ3RELE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLENBQUM7UUFDM0IsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUN4QixDQUFDOzhHQXZDVSxxQkFBcUIsaUdBSVYsZUFBZTtrSEFKMUIscUJBQXFCOzsyRkFBckIscUJBQXFCO2tCQURqQyxVQUFVOzswQkFLTixRQUFROzswQkFBSSxNQUFNOzJCQUFDLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgUGFyYW1NYXAgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IGVxdWFsIGZyb20gJ2Zhc3QtZGVlcC1lcXVhbC9lczYnO1xuaW1wb3J0IHsgZnJvbSwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY29uY2F0TWFwLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwLCBzaGFyZVJlcGxheSwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IElOSVRfU09SVF9UT0tFTiB9IGZyb20gJy4vb3JkZXItdG9rZW4nO1xuaW1wb3J0IHsgU29ydFNlcnZpY2UgfSBmcm9tICcuL3NvcnQuc2VydmljZSc7XG5pbXBvcnQgeyBTb3J0RXZlbnQgfSBmcm9tICcuL3NvcnQtZXZlbnQnO1xuaW1wb3J0IHsgUXVlcnlQYXJhbXNOYXZpZ2F0aW9uUXVldWVTZXJ2aWNlLCB0b1F1ZXJ5UGFyYW1zIH0gZnJvbSAnQHNlbnRpbmVsL2NvbW1vbi91dGlscyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBRdWVyeVBhcmFtU29ydFNlcnZpY2UgZXh0ZW5kcyBTb3J0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBxdWVyeVBhcmFtc1F1ZXVlU2VydmljZTogUXVlcnlQYXJhbXNOYXZpZ2F0aW9uUXVldWVTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoSU5JVF9TT1JUX1RPS0VOKSBwcm90ZWN0ZWQgcmVhZG9ubHkgaW5pdFNvcnQ/OiBTb3J0RXZlbnQsXG4gICkge1xuICAgIHN1cGVyKGluaXRTb3J0KTtcbiAgICB0aGlzLnNvcnQkID0gdGhpcy5jcmVhdGVTb3J0T2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHVwZGF0ZVF1ZXJ5UGFyYW1zKHNvcnQ6IFNvcnRFdmVudCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiBmcm9tKHRoaXMucXVlcnlQYXJhbXNRdWV1ZVNlcnZpY2UuZW5xdWV1ZSh0b1F1ZXJ5UGFyYW1zPFNvcnRFdmVudD4oc29ydCkpKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlU29ydE9ic2VydmFibGUoKTogT2JzZXJ2YWJsZTxTb3J0RXZlbnQ+IHtcbiAgICByZXR1cm4gdGhpcy5mcm9tUm91dGUoKS5waXBlKFxuICAgICAgdGFrZSgxKSxcbiAgICAgIGNvbmNhdE1hcCgoKSA9PiB0aGlzLnNvcnRTdWJqZWN0JCksXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgocHJldiwgY3VycikgPT4gZXF1YWwocHJldiwgY3VycikpLFxuICAgICAgY29uY2F0TWFwKChzb3J0KSA9PiB0aGlzLnVwZGF0ZVF1ZXJ5UGFyYW1zKHNvcnQpLnBpcGUobWFwKCgpID0+IHNvcnQpKSksXG4gICAgICBzaGFyZVJlcGxheSh7IHJlZkNvdW50OiB0cnVlIH0pLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGZyb21Sb3V0ZSgpOiBPYnNlcnZhYmxlPFNvcnRFdmVudD4ge1xuICAgIHJldHVybiB0aGlzLmFjdGl2YXRlZFJvdXRlLnF1ZXJ5UGFyYW1NYXAucGlwZShcbiAgICAgIHRha2UoMSksXG4gICAgICBtYXAoKHBhcmFtTWFwKSA9PiB0aGlzLnNvcnRGcm9tUGFyYW1NYXAocGFyYW1NYXApKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzb3J0RnJvbVBhcmFtTWFwKHBhcmFtTWFwOiBQYXJhbU1hcCk6IFNvcnRFdmVudCB7XG4gICAgY29uc3Qgc29ydCA9IHBhcmFtTWFwLmdldCgnc29ydCcpO1xuICAgIGNvbnN0IHNvcnREaXJTdHIgPSBwYXJhbU1hcC5nZXQoJ3NvcnREaXInKTtcbiAgICBpZiAoc29ydCAhPT0gbnVsbCAmJiBzb3J0RGlyU3RyICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBzb3J0RGlyID0gc29ydERpclN0ciA9PT0gJ2FzYycgPyAnYXNjJyA6ICdkZXNjJztcbiAgICAgIHJldHVybiB7IHNvcnQsIHNvcnREaXIgfTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuSU5JVF9TT1JUO1xuICB9XG59XG4iXX0=