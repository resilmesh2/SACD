import { ResourceService } from './resource.service';
import { merge, Subject, timer } from 'rxjs';
import { retryWhen, switchMap } from 'rxjs/operators';
/**
 * Adds polling behaviour to resource service
 */
export class ResourcePollingService extends ResourceService {
    constructor(pollPeriod = 5000) {
        super();
        /**
         * Observable triggering retry of polling after it was interrupted (e.g. by error)
         */
        this.retryPolling$ = new Subject();
        this.pollPeriod = pollPeriod;
        this.resource$ = merge(this.createPoll(), this.resourceSubject$.asObservable());
    }
    /**
     * Performs necessary operations and updates state of the service.
     * @contract Needs to update hasError subject and retry polling
     * if it was previously interrupted
     * @param params any other parameters required to update data in your concrete service
     */
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    onManualResourceRefresh(...params) {
        if (this.hasErrorSubject$.getValue()) {
            this.retryPolling$.next(true);
        }
        this.hasErrorSubject$.next(false);
    }
    /**
     * Creates poll observable using a timer. You can extend the behaviour by piping the observable and applying
     * RxJs operators on it (e.g. takeWhile to stop polling on specific conditions)
     * @param dueTime optionally set a due time when the timer should start. By default it equals to the
     * poll period as it is expected that the first request is made from the service or component
     * using the service (to properly set up pagination and all other possible params like ids etc)
     */
    createPoll(dueTime = this.pollPeriod) {
        return timer(dueTime, this.pollPeriod).pipe(switchMap(() => this.refreshResource()), retryWhen(() => this.retryPolling$));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb3VyY2UtcG9sbGluZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvc2VudGluZWwtY29tbW9uL3NyYy9zZXJ2aWNlcy9yZXNvdXJjZS1wb2xsaW5nLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxLQUFLLEVBQWMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN6RCxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXREOztHQUVHO0FBQ0gsTUFBTSxPQUFnQixzQkFBMEIsU0FBUSxlQUFrQjtJQVF4RSxZQUFzQixVQUFVLEdBQUcsSUFBSTtRQUNyQyxLQUFLLEVBQUUsQ0FBQztRQVJWOztXQUVHO1FBQ08sa0JBQWEsR0FBcUIsSUFBSSxPQUFPLEVBQVcsQ0FBQztRQU1qRSxJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUM3QixJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7SUFDbEYsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsNkRBQTZEO0lBQ25ELHVCQUF1QixDQUFDLEdBQUcsTUFBaUI7UUFDcEQsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQztZQUNyQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoQyxDQUFDO1FBQ0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBUUQ7Ozs7OztPQU1HO0lBQ08sVUFBVSxDQUFDLFVBQWtCLElBQUksQ0FBQyxVQUFVO1FBQ3BELE9BQU8sS0FBSyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUN6QyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLEVBQ3ZDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQ3BDLENBQUM7SUFDSixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXNvdXJjZVNlcnZpY2UgfSBmcm9tICcuL3Jlc291cmNlLnNlcnZpY2UnO1xuaW1wb3J0IHsgbWVyZ2UsIE9ic2VydmFibGUsIFN1YmplY3QsIHRpbWVyIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyByZXRyeVdoZW4sIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuLyoqXG4gKiBBZGRzIHBvbGxpbmcgYmVoYXZpb3VyIHRvIHJlc291cmNlIHNlcnZpY2VcbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFJlc291cmNlUG9sbGluZ1NlcnZpY2U8VD4gZXh0ZW5kcyBSZXNvdXJjZVNlcnZpY2U8VD4ge1xuICAvKipcbiAgICogT2JzZXJ2YWJsZSB0cmlnZ2VyaW5nIHJldHJ5IG9mIHBvbGxpbmcgYWZ0ZXIgaXQgd2FzIGludGVycnVwdGVkIChlLmcuIGJ5IGVycm9yKVxuICAgKi9cbiAgcHJvdGVjdGVkIHJldHJ5UG9sbGluZyQ6IFN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xuXG4gIHByaXZhdGUgcG9sbFBlcmlvZDogbnVtYmVyO1xuXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3Rvcihwb2xsUGVyaW9kID0gNTAwMCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5wb2xsUGVyaW9kID0gcG9sbFBlcmlvZDtcbiAgICB0aGlzLnJlc291cmNlJCA9IG1lcmdlKHRoaXMuY3JlYXRlUG9sbCgpLCB0aGlzLnJlc291cmNlU3ViamVjdCQuYXNPYnNlcnZhYmxlKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm1zIG5lY2Vzc2FyeSBvcGVyYXRpb25zIGFuZCB1cGRhdGVzIHN0YXRlIG9mIHRoZSBzZXJ2aWNlLlxuICAgKiBAY29udHJhY3QgTmVlZHMgdG8gdXBkYXRlIGhhc0Vycm9yIHN1YmplY3QgYW5kIHJldHJ5IHBvbGxpbmdcbiAgICogaWYgaXQgd2FzIHByZXZpb3VzbHkgaW50ZXJydXB0ZWRcbiAgICogQHBhcmFtIHBhcmFtcyBhbnkgb3RoZXIgcGFyYW1ldGVycyByZXF1aXJlZCB0byB1cGRhdGUgZGF0YSBpbiB5b3VyIGNvbmNyZXRlIHNlcnZpY2VcbiAgICovXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnNcbiAgcHJvdGVjdGVkIG9uTWFudWFsUmVzb3VyY2VSZWZyZXNoKC4uLnBhcmFtczogdW5rbm93bltdKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaGFzRXJyb3JTdWJqZWN0JC5nZXRWYWx1ZSgpKSB7XG4gICAgICB0aGlzLnJldHJ5UG9sbGluZyQubmV4dCh0cnVlKTtcbiAgICB9XG4gICAgdGhpcy5oYXNFcnJvclN1YmplY3QkLm5leHQoZmFsc2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBjb250cmFjdCBtdXN0IHVwZGF0ZSByZXNvdXJjZSBhbmQgaGFzRXJyb3JTdWJqZWN0XG4gICAqIEltcGxlbWVudCB0aGlzIHRvIHBlcmZvcm0gYSByZWZyZXNoIG9mIHRoZSByZXNvdXJjZSBvbiBwb2xsaW5nIHBlcmlvZFxuICAgKi9cbiAgcHJvdGVjdGVkIGFic3RyYWN0IHJlZnJlc2hSZXNvdXJjZSgpOiBPYnNlcnZhYmxlPFQ+O1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIHBvbGwgb2JzZXJ2YWJsZSB1c2luZyBhIHRpbWVyLiBZb3UgY2FuIGV4dGVuZCB0aGUgYmVoYXZpb3VyIGJ5IHBpcGluZyB0aGUgb2JzZXJ2YWJsZSBhbmQgYXBwbHlpbmdcbiAgICogUnhKcyBvcGVyYXRvcnMgb24gaXQgKGUuZy4gdGFrZVdoaWxlIHRvIHN0b3AgcG9sbGluZyBvbiBzcGVjaWZpYyBjb25kaXRpb25zKVxuICAgKiBAcGFyYW0gZHVlVGltZSBvcHRpb25hbGx5IHNldCBhIGR1ZSB0aW1lIHdoZW4gdGhlIHRpbWVyIHNob3VsZCBzdGFydC4gQnkgZGVmYXVsdCBpdCBlcXVhbHMgdG8gdGhlXG4gICAqIHBvbGwgcGVyaW9kIGFzIGl0IGlzIGV4cGVjdGVkIHRoYXQgdGhlIGZpcnN0IHJlcXVlc3QgaXMgbWFkZSBmcm9tIHRoZSBzZXJ2aWNlIG9yIGNvbXBvbmVudFxuICAgKiB1c2luZyB0aGUgc2VydmljZSAodG8gcHJvcGVybHkgc2V0IHVwIHBhZ2luYXRpb24gYW5kIGFsbCBvdGhlciBwb3NzaWJsZSBwYXJhbXMgbGlrZSBpZHMgZXRjKVxuICAgKi9cbiAgcHJvdGVjdGVkIGNyZWF0ZVBvbGwoZHVlVGltZTogbnVtYmVyID0gdGhpcy5wb2xsUGVyaW9kKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgcmV0dXJuIHRpbWVyKGR1ZVRpbWUsIHRoaXMucG9sbFBlcmlvZCkucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLnJlZnJlc2hSZXNvdXJjZSgpKSxcbiAgICAgIHJldHJ5V2hlbigoKSA9PiB0aGlzLnJldHJ5UG9sbGluZyQpLFxuICAgICk7XG4gIH1cbn1cbiJdfQ==