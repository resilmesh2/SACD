import { merge, Subject, timer } from 'rxjs';
import { retryWhen, switchMap } from 'rxjs/operators';
import { PaginatedElementsService } from './paginated-elements.service';
/**
 * Adds polling behaviour to paginated elements service
 */
export class PaginatedElementsPollingService extends PaginatedElementsService {
    constructor(defaultPaginationSize, pollPeriod) {
        super(defaultPaginationSize);
        /**
         * Observable triggering retry of polling after it was interrupted (e.g. by error)
         */
        this.retryPolling$ = new Subject();
        this.pollPeriod = pollPeriod;
        this.resource$ = merge(this.createPoll(), this.resourceSubject$.asObservable());
    }
    /**
     * Performs necessary operations and updates state of the service.
     * @contract Needs to update lastPagination attribute, hasError subject and retry polling
     * if it was previously interrupted
     * @param pagination new requested pagination
     * @param params any other parameters required to update data in your concrete service
     */
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    onManualResourceRefresh(pagination, ...params) {
        this.lastPagination = pagination;
        if (this.hasErrorSubject$.getValue()) {
            this.retryPolling$.next(true);
        }
        this.hasErrorSubject$.next(false);
    }
    /**
     * Creates poll observable using a timer. You can extend the behaviour by piping the observable and applying
     * RxJs operators on it (e.g. takeWhile to stop polling on specific conditions)
     * @param dueTime optionally set a due time when the timer should start. By default it equals to the
     * poll period as it is expected that the first request is made from the service or component
     * using the service (to properly set up pagination and all other possible params like ids etc)
     */
    createPoll(dueTime = this.pollPeriod) {
        return timer(dueTime, this.pollPeriod).pipe(switchMap(() => this.refreshResource()), retryWhen(() => this.retryPolling$));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnaW5hdGVkLWVsZW1lbnRzLXBvbGxpbmcuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3NlbnRpbmVsLWNvbW1vbi9zcmMvc2VydmljZXMvcGFnaW5hdGVkLWVsZW1lbnRzL3BhZ2luYXRlZC1lbGVtZW50cy1wb2xsaW5nLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLEtBQUssRUFBYyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3pELE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFHeEU7O0dBRUc7QUFDSCxNQUFNLE9BQWdCLCtCQUFtQyxTQUFRLHdCQUEyQjtJQWMxRixZQUFzQixxQkFBNkIsRUFBRSxVQUFrQjtRQUNyRSxLQUFLLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQVIvQjs7V0FFRztRQUNPLGtCQUFhLEdBQXFCLElBQUksT0FBTyxFQUFXLENBQUM7UUFNakUsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO0lBQ2xGLENBQUM7SUFFRDs7Ozs7O09BTUc7SUFDSCw2REFBNkQ7SUFDbkQsdUJBQXVCLENBQUMsVUFBK0IsRUFBRSxHQUFHLE1BQWlCO1FBQ3JGLElBQUksQ0FBQyxjQUFjLEdBQUcsVUFBVSxDQUFDO1FBQ2pDLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUM7WUFDckMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEMsQ0FBQztRQUNELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQVFEOzs7Ozs7T0FNRztJQUNPLFVBQVUsQ0FBQyxVQUFrQixJQUFJLENBQUMsVUFBVTtRQUNwRCxPQUFPLEtBQUssQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FDekMsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxFQUN2QyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUNwQyxDQUFDO0lBQ0osQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbWVyZ2UsIE9ic2VydmFibGUsIFN1YmplY3QsIHRpbWVyIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyByZXRyeVdoZW4sIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFBhZ2luYXRlZEVsZW1lbnRzU2VydmljZSB9IGZyb20gJy4vcGFnaW5hdGVkLWVsZW1lbnRzLnNlcnZpY2UnO1xuaW1wb3J0IHsgSVBhZ2luYXRlZEVsZW1lbnRzLCBQYWdpbmF0aW9uQmFzZUV2ZW50IH0gZnJvbSAnQHNlbnRpbmVsL2NvbW1vbi9wYWdpbmF0aW9uJztcblxuLyoqXG4gKiBBZGRzIHBvbGxpbmcgYmVoYXZpb3VyIHRvIHBhZ2luYXRlZCBlbGVtZW50cyBzZXJ2aWNlXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBQYWdpbmF0ZWRFbGVtZW50c1BvbGxpbmdTZXJ2aWNlPFQ+IGV4dGVuZHMgUGFnaW5hdGVkRWxlbWVudHNTZXJ2aWNlPFQ+IHtcbiAgLyoqXG4gICAqIEBjb250cmFjdCBOZWVkcyB0byBiZSB1cGRhdGVkIGluIG9uTWFudWFsUmVzb3VyY2VSZWZyZXNoIG1ldGhvZFxuICAgKiBMYXN0IHBhZ2luYXRpb24gdXNlZCB3aGVuIHJlcXVlc3RpbmcgbmV3IGRhdGFcbiAgICovXG4gIHByb3RlY3RlZCBsYXN0UGFnaW5hdGlvbj86IFBhZ2luYXRpb25CYXNlRXZlbnQ7XG5cbiAgLyoqXG4gICAqIE9ic2VydmFibGUgdHJpZ2dlcmluZyByZXRyeSBvZiBwb2xsaW5nIGFmdGVyIGl0IHdhcyBpbnRlcnJ1cHRlZCAoZS5nLiBieSBlcnJvcilcbiAgICovXG4gIHByb3RlY3RlZCByZXRyeVBvbGxpbmckOiBTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcblxuICBwcml2YXRlIHBvbGxQZXJpb2Q6IG51bWJlcjtcblxuICBwcm90ZWN0ZWQgY29uc3RydWN0b3IoZGVmYXVsdFBhZ2luYXRpb25TaXplOiBudW1iZXIsIHBvbGxQZXJpb2Q6IG51bWJlcikge1xuICAgIHN1cGVyKGRlZmF1bHRQYWdpbmF0aW9uU2l6ZSk7XG4gICAgdGhpcy5wb2xsUGVyaW9kID0gcG9sbFBlcmlvZDtcbiAgICB0aGlzLnJlc291cmNlJCA9IG1lcmdlKHRoaXMuY3JlYXRlUG9sbCgpLCB0aGlzLnJlc291cmNlU3ViamVjdCQuYXNPYnNlcnZhYmxlKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm1zIG5lY2Vzc2FyeSBvcGVyYXRpb25zIGFuZCB1cGRhdGVzIHN0YXRlIG9mIHRoZSBzZXJ2aWNlLlxuICAgKiBAY29udHJhY3QgTmVlZHMgdG8gdXBkYXRlIGxhc3RQYWdpbmF0aW9uIGF0dHJpYnV0ZSwgaGFzRXJyb3Igc3ViamVjdCBhbmQgcmV0cnkgcG9sbGluZ1xuICAgKiBpZiBpdCB3YXMgcHJldmlvdXNseSBpbnRlcnJ1cHRlZFxuICAgKiBAcGFyYW0gcGFnaW5hdGlvbiBuZXcgcmVxdWVzdGVkIHBhZ2luYXRpb25cbiAgICogQHBhcmFtIHBhcmFtcyBhbnkgb3RoZXIgcGFyYW1ldGVycyByZXF1aXJlZCB0byB1cGRhdGUgZGF0YSBpbiB5b3VyIGNvbmNyZXRlIHNlcnZpY2VcbiAgICovXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnNcbiAgcHJvdGVjdGVkIG9uTWFudWFsUmVzb3VyY2VSZWZyZXNoKHBhZ2luYXRpb246IFBhZ2luYXRpb25CYXNlRXZlbnQsIC4uLnBhcmFtczogdW5rbm93bltdKTogdm9pZCB7XG4gICAgdGhpcy5sYXN0UGFnaW5hdGlvbiA9IHBhZ2luYXRpb247XG4gICAgaWYgKHRoaXMuaGFzRXJyb3JTdWJqZWN0JC5nZXRWYWx1ZSgpKSB7XG4gICAgICB0aGlzLnJldHJ5UG9sbGluZyQubmV4dCh0cnVlKTtcbiAgICB9XG4gICAgdGhpcy5oYXNFcnJvclN1YmplY3QkLm5leHQoZmFsc2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBjb250cmFjdCBtdXN0IHVwZGF0ZSByZXNvdXJjZSBhbmQgaGFzRXJyb3JTdWJqZWN0XG4gICAqIEltcGxlbWVudCB0aGlzIHRvIHBlcmZvcm0gYSByZWZyZXNoIG9mIHRoZSByZXNvdXJjZSBvbiBwb2xsaW5nIHBlcmlvZFxuICAgKi9cbiAgcHJvdGVjdGVkIGFic3RyYWN0IHJlZnJlc2hSZXNvdXJjZSgpOiBPYnNlcnZhYmxlPElQYWdpbmF0ZWRFbGVtZW50czxUPj47XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgcG9sbCBvYnNlcnZhYmxlIHVzaW5nIGEgdGltZXIuIFlvdSBjYW4gZXh0ZW5kIHRoZSBiZWhhdmlvdXIgYnkgcGlwaW5nIHRoZSBvYnNlcnZhYmxlIGFuZCBhcHBseWluZ1xuICAgKiBSeEpzIG9wZXJhdG9ycyBvbiBpdCAoZS5nLiB0YWtlV2hpbGUgdG8gc3RvcCBwb2xsaW5nIG9uIHNwZWNpZmljIGNvbmRpdGlvbnMpXG4gICAqIEBwYXJhbSBkdWVUaW1lIG9wdGlvbmFsbHkgc2V0IGEgZHVlIHRpbWUgd2hlbiB0aGUgdGltZXIgc2hvdWxkIHN0YXJ0LiBCeSBkZWZhdWx0IGl0IGVxdWFscyB0byB0aGVcbiAgICogcG9sbCBwZXJpb2QgYXMgaXQgaXMgZXhwZWN0ZWQgdGhhdCB0aGUgZmlyc3QgcmVxdWVzdCBpcyBtYWRlIGZyb20gdGhlIHNlcnZpY2Ugb3IgY29tcG9uZW50XG4gICAqIHVzaW5nIHRoZSBzZXJ2aWNlICh0byBwcm9wZXJseSBzZXQgdXAgcGFnaW5hdGlvbiBhbmQgYWxsIG90aGVyIHBvc3NpYmxlIHBhcmFtcyBsaWtlIGlkcyBldGMpXG4gICAqL1xuICBwcm90ZWN0ZWQgY3JlYXRlUG9sbChkdWVUaW1lOiBudW1iZXIgPSB0aGlzLnBvbGxQZXJpb2QpOiBPYnNlcnZhYmxlPElQYWdpbmF0ZWRFbGVtZW50czxUPj4ge1xuICAgIHJldHVybiB0aW1lcihkdWVUaW1lLCB0aGlzLnBvbGxQZXJpb2QpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5yZWZyZXNoUmVzb3VyY2UoKSksXG4gICAgICByZXRyeVdoZW4oKCkgPT4gdGhpcy5yZXRyeVBvbGxpbmckKSxcbiAgICApO1xuICB9XG59XG4iXX0=