import { NetworkStatus } from '@apollo/client/core';
import { createApolloContextErrorTitle, createApolloContextIgnoreErrorMessage, createApolloContextRetryable, } from '@sentinel/common/graphql';
import { BehaviorSubject, EMPTY, of } from 'rxjs';
import { catchError, distinctUntilChanged, filter, map, shareReplay, switchMap, tap } from 'rxjs/operators';
const DEFAULT_OPTIONS = {
    fetchPolicy: 'network-only',
    pollInterval: undefined,
    retryable: true,
    ignoreErrorMessage: false,
};
export class ApolloQueryService {
    constructor(getQuery, operationName, options) {
        this.getQuery = getQuery;
        this.initialized$ = new BehaviorSubject(false);
        this.isInErrorState = false;
        this.operationName = operationName;
        this.options = options ?? DEFAULT_OPTIONS;
        this.data$ = this.initialized$.pipe(shareReplay({ refCount: true }), switchMap(() => this.queryRef?.valueChanges.pipe(
        // ignoring all responses not containing data
        filter((queryRes) => queryRes.data !== undefined && queryRes.networkStatus === NetworkStatus.ready), map((queryRes) => this.toData(queryRes)), catchError(() => EMPTY)) ?? EMPTY));
        this.isRefetching$ = this.initialized$.pipe(switchMap(() => this.queryRef?.valueChanges.pipe(map((queryRes) => (queryRes.networkStatus === NetworkStatus.refetch && queryRes.loading) ||
            queryRes.error !== undefined ||
            false), catchError(() => of(false)), distinctUntilChanged()) ?? EMPTY));
        this.isLoading$ = this.initialized$.pipe(switchMap(() => this.loadingInternal$ ?? EMPTY));
        this.hasError$ = this.initialized$.pipe(switchMap(() => this.hasErrorInternal$ ?? EMPTY));
    }
    recoverAfterError() {
        this.initialize();
    }
    initialize() {
        this.initQueryWatch();
        this.initLoading();
        this.initHasError();
        this.initialized$.next(true);
    }
    initQueryWatch() {
        this.queryRef = this.getQuery.watch(this.variables, {
            useInitialLoading: true,
            pollInterval: this.options?.pollInterval ?? DEFAULT_OPTIONS.pollInterval,
            fetchPolicy: this.options.fetchPolicy ?? DEFAULT_OPTIONS.fetchPolicy,
            nextFetchPolicy: 'network-only',
            errorPolicy: 'all',
            returnPartialData: true,
            notifyOnNetworkStatusChange: true, // to get all updates on loading state
            context: {
                ...createApolloContextErrorTitle(this.operationName),
                ...createApolloContextIgnoreErrorMessage(this.options?.ignoreErrorMessage !== undefined
                    ? this.options.ignoreErrorMessage
                    : DEFAULT_OPTIONS.ignoreErrorMessage ?? false),
                ...createApolloContextRetryable(this.options?.retryable !== undefined ? this.options?.retryable : DEFAULT_OPTIONS.retryable ?? true),
            },
        });
    }
    update(updateVariables) {
        this.variables = this.createVariables(updateVariables);
        if (!this.initialized$.getValue()) {
            this.initialize();
        }
        if (this.isInErrorState) {
            this.initialize();
        }
        if (this.queryRef && this.variables) {
            this.queryRef.setVariables(this.variables);
        }
    }
    refetch(updateVariables) {
        if (this.queryRef) {
            this.queryRef.options.context = {
                ...this.queryRef.options.context,
                ...createApolloContextIgnoreErrorMessage(true),
            };
        }
        this.variables = this.createVariables(updateVariables);
        this.queryRef?.refetch(this.variables);
    }
    initLoading() {
        if (this.queryRef) {
            this.loadingInternal$ = this.queryRef.valueChanges.pipe(
            // we ignore refetch loadings before it causes bad ux.
            filter((queryRes) => queryRes.networkStatus !== NetworkStatus.refetch), map((queryRes) => queryRes.loading || queryRes.error !== undefined), catchError(() => of(false)), distinctUntilChanged());
        }
    }
    initHasError() {
        if (this.queryRef) {
            const ref = this.queryRef;
            this.hasErrorInternal$ = ref.valueChanges.pipe(map((queryRes) => this.hasError(queryRes)), catchError(() => of(true)), distinctUntilChanged(), tap((hasError) => (this.isInErrorState = hasError)));
        }
    }
    hasError(queryRes) {
        return (queryRes.error !== undefined || queryRes.errors !== undefined || queryRes.networkStatus === NetworkStatus.error);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBvbGxvLXF1ZXJ5LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9zZW50aW5lbC1jb21tb24vYXBvbGxvLXNlcnZpY2VzL3NyYy9nZW5lcmFsL2Fwb2xsby1xdWVyeS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBcUIsYUFBYSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFdkUsT0FBTyxFQUNMLDZCQUE2QixFQUM3QixxQ0FBcUMsRUFDckMsNEJBQTRCLEdBQzdCLE1BQU0sMEJBQTBCLENBQUM7QUFHbEMsT0FBTyxFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzlELE9BQU8sRUFBRSxVQUFVLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBVTVHLE1BQU0sZUFBZSxHQUE4QjtJQUNqRCxXQUFXLEVBQUUsY0FBYztJQUMzQixZQUFZLEVBQUUsU0FBUztJQUN2QixTQUFTLEVBQUUsSUFBSTtJQUNmLGtCQUFrQixFQUFFLEtBQUs7Q0FDMUIsQ0FBQztBQUVGLE1BQU0sT0FBZ0Isa0JBQWtCO0lBaUJ0QyxZQUNTLFFBQTZDLEVBQ3BELGFBQXFCLEVBQ3JCLE9BQW1DO1FBRjVCLGFBQVEsR0FBUixRQUFRLENBQXFDO1FBUDVDLGlCQUFZLEdBQTZCLElBQUksZUFBZSxDQUFVLEtBQUssQ0FBQyxDQUFDO1FBRS9FLG1CQUFjLEdBQUcsS0FBSyxDQUFDO1FBUzdCLElBQUksQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFDO1FBQ25DLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxJQUFJLGVBQWUsQ0FBQztRQUMxQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUNqQyxXQUFX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QyxLQUFLLENBQ2hILENBQUM7SUFDSixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcG9sbG9RdWVyeVJlc3VsdCwgTmV0d29ya1N0YXR1cyB9IGZyb20gJ0BhcG9sbG8vY2xpZW50L2NvcmUnO1xuaW1wb3J0IHsgV2F0Y2hRdWVyeUZldGNoUG9saWN5IH0gZnJvbSAnQGFwb2xsby9jbGllbnQvY29yZS93YXRjaFF1ZXJ5T3B0aW9ucyc7XG5pbXBvcnQge1xuICBjcmVhdGVBcG9sbG9Db250ZXh0RXJyb3JUaXRsZSxcbiAgY3JlYXRlQXBvbGxvQ29udGV4dElnbm9yZUVycm9yTWVzc2FnZSxcbiAgY3JlYXRlQXBvbGxvQ29udGV4dFJldHJ5YWJsZSxcbn0gZnJvbSAnQHNlbnRpbmVsL2NvbW1vbi9ncmFwaHFsJztcbmltcG9ydCAqIGFzIEFwb2xsbyBmcm9tICdhcG9sbG8tYW5ndWxhcic7XG5pbXBvcnQgeyBRdWVyeVJlZiB9IGZyb20gJ2Fwb2xsby1hbmd1bGFyJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgRU1QVFksIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZmlsdGVyLCBtYXAsIHNoYXJlUmVwbGF5LCBzd2l0Y2hNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE9wZXJhdGlvblZhcmlhYmxlcyB9IGZyb20gJ0BhcG9sbG8vY2xpZW50L2NvcmUvdHlwZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFwb2xsb1F1ZXJ5U2VydmljZU9wdGlvbnMge1xuICBmZXRjaFBvbGljeT86IFdhdGNoUXVlcnlGZXRjaFBvbGljeTtcbiAgcG9sbEludGVydmFsPzogbnVtYmVyO1xuICByZXRyeWFibGU/OiBib29sZWFuO1xuICBpZ25vcmVFcnJvck1lc3NhZ2U/OiBib29sZWFuO1xufVxuXG5jb25zdCBERUZBVUxUX09QVElPTlM6IEFwb2xsb1F1ZXJ5U2VydmljZU9wdGlvbnMgPSB7XG4gIGZldGNoUG9saWN5OiAnbmV0d29yay1vbmx5JyxcbiAgcG9sbEludGVydmFsOiB1bmRlZmluZWQsXG4gIHJldHJ5YWJsZTogdHJ1ZSxcbiAgaWdub3JlRXJyb3JNZXNzYWdlOiBmYWxzZSxcbn07XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBBcG9sbG9RdWVyeVNlcnZpY2U8UXVlcnksIFF1ZXJ5VmFyaWFibGVzIGV4dGVuZHMgT3BlcmF0aW9uVmFyaWFibGVzLCBEYXRhLCBVcGRhdGVWYXJpYWJsZXM+IHtcbiAgcXVlcnlSZWY/OiBRdWVyeVJlZjxRdWVyeSwgUXVlcnlWYXJpYWJsZXM+O1xuICBvcGVyYXRpb25OYW1lOiBzdHJpbmc7XG4gIGRhdGEkOiBPYnNlcnZhYmxlPERhdGE+O1xuICBpc0xvYWRpbmckOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuICBpc1JlZmV0Y2hpbmckOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuICBoYXNFcnJvciQ/OiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuXG4gIHByb3RlY3RlZCBsb2FkaW5nSW50ZXJuYWwkPzogT2JzZXJ2YWJsZTxib29sZWFuPjtcbiAgcHJvdGVjdGVkIGhhc0Vycm9ySW50ZXJuYWwkPzogT2JzZXJ2YWJsZTxib29sZWFuPjtcbiAgcHJvdGVjdGVkIHZhcmlhYmxlcz86IFF1ZXJ5VmFyaWFibGVzO1xuICBwcm90ZWN0ZWQgaW5pdGlhbGl6ZWQkOiBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKTtcblxuICBwcml2YXRlIGlzSW5FcnJvclN0YXRlID0gZmFsc2U7XG4gIHByaXZhdGUgb3B0aW9uczogQXBvbGxvUXVlcnlTZXJ2aWNlT3B0aW9ucztcbiAgcHJvdGVjdGVkIGFic3RyYWN0IHRvRGF0YShxdWVyeVJlczogQXBvbGxvUXVlcnlSZXN1bHQ8UXVlcnk+KTogRGF0YTtcblxuICBwcm90ZWN0ZWQgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGdldFF1ZXJ5OiBBcG9sbG8uUXVlcnk8UXVlcnksIFF1ZXJ5VmFyaWFibGVzPixcbiAgICBvcGVyYXRpb25OYW1lOiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IEFwb2xsb1F1ZXJ5U2VydmljZU9wdGlvbnMsXG4gICkge1xuICAgIHRoaXMub3BlcmF0aW9uTmFtZSA9IG9wZXJhdGlvbk5hbWU7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucyA/PyBERUZBVUxUX09QVElPTlM7XG4gICAgdGhpcy5kYXRhJCA9IHRoaXMuaW5pdGlhbGl6ZWQkLnBpcGUoXG4gICAgICBzaGFyZVJlcGxheSh7IHJlZkNvdW50OiB0cnVlIH0pLFxuICAgICAgc3dpdGNoTWFwKFxuICAgICAgICAoKSA9PlxuICAgICAgICAgIHRoaXMucXVlcnlSZWY/LnZhbHVlQ2hhbmdlcy5waXBlKFxuICAgICAgICAgICAgLy8gaWdub3JpbmcgYWxsIHJlc3BvbnNlcyBub3QgY29udGFpbmluZyBkYXRhXG4gICAgICAgICAgICBmaWx0ZXIoKHF1ZXJ5UmVzKSA9PiBxdWVyeVJlcy5kYXRhICE9PSB1bmRlZmluZWQgJiYgcXVlcnlSZXMubmV0d29ya1N0YXR1cyA9PT0gTmV0d29ya1N0YXR1cy5yZWFkeSksXG4gICAgICAgICAgICBtYXAoKHF1ZXJ5UmVzKSA9PiB0aGlzLnRvRGF0YShxdWVyeVJlcykpLFxuICAgICAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBFTVBUWSksXG4gICAgICAgICAgKSA/PyBFTVBUWSxcbiAgICAgICksXG4gICAgKTtcbiAgICB0aGlzLmlzUmVmZXRjaGluZyQgPSB0aGlzLmluaXRpYWxpemVkJC5waXBlKFxuICAgICAgc3dpdGNoTWFwKFxuICAgICAgICAoKSA9PlxuICAgICAgICAgIHRoaXMucXVlcnlSZWY/LnZhbHVlQ2hhbmdlcy5waXBlKFxuICAgICAgICAgICAgbWFwKFxuICAgICAgICAgICAgICAocXVlcnlSZXMpID0+XG4gICAgICAgICAgICAgICAgKHF1ZXJ5UmVzLm5ldHdvcmtTdGF0dXMgPT09IE5ldHdvcmtTdGF0dXMucmVmZXRjaCAmJiBxdWVyeVJlcy5sb2FkaW5nKSB8fFxuICAgICAgICAgICAgICAgIHF1ZXJ5UmVzLmVycm9yICE9PSB1bmRlZmluZWQgfHxcbiAgICAgICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IG9mKGZhbHNlKSksXG4gICAgICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICAgICkgPz8gRU1QVFksXG4gICAgICApLFxuICAgICk7XG4gICAgdGhpcy5pc0xvYWRpbmckID0gdGhpcy5pbml0aWFsaXplZCQucGlwZShzd2l0Y2hNYXAoKCkgPT4gdGhpcy5sb2FkaW5nSW50ZXJuYWwkID8/IEVNUFRZKSk7XG4gICAgdGhpcy5oYXNFcnJvciQgPSB0aGlzLmluaXRpYWxpemVkJC5waXBlKHN3aXRjaE1hcCgoKSA9PiB0aGlzLmhhc0Vycm9ySW50ZXJuYWwkID8/IEVNUFRZKSk7XG4gIH1cblxuICBwdWJsaWMgcmVjb3ZlckFmdGVyRXJyb3IoKTogdm9pZCB7XG4gICAgdGhpcy5pbml0aWFsaXplKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgY3JlYXRlVmFyaWFibGVzKGFyZ3M6IFVwZGF0ZVZhcmlhYmxlcyk6IFF1ZXJ5VmFyaWFibGVzO1xuXG4gIHByb3RlY3RlZCBpbml0aWFsaXplKCk6IHZvaWQge1xuICAgIHRoaXMuaW5pdFF1ZXJ5V2F0Y2goKTtcbiAgICB0aGlzLmluaXRMb2FkaW5nKCk7XG4gICAgdGhpcy5pbml0SGFzRXJyb3IoKTtcbiAgICB0aGlzLmluaXRpYWxpemVkJC5uZXh0KHRydWUpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGluaXRRdWVyeVdhdGNoKCk6IHZvaWQge1xuICAgIHRoaXMucXVlcnlSZWYgPSB0aGlzLmdldFF1ZXJ5LndhdGNoKHRoaXMudmFyaWFibGVzLCB7XG4gICAgICB1c2VJbml0aWFsTG9hZGluZzogdHJ1ZSxcbiAgICAgIHBvbGxJbnRlcnZhbDogdGhpcy5vcHRpb25zPy5wb2xsSW50ZXJ2YWwgPz8gREVGQVVMVF9PUFRJT05TLnBvbGxJbnRlcnZhbCxcbiAgICAgIGZldGNoUG9saWN5OiB0aGlzLm9wdGlvbnMuZmV0Y2hQb2xpY3kgPz8gREVGQVVMVF9PUFRJT05TLmZldGNoUG9saWN5LFxuICAgICAgbmV4dEZldGNoUG9saWN5OiAnbmV0d29yay1vbmx5JyxcbiAgICAgIGVycm9yUG9saWN5OiAnYWxsJyxcbiAgICAgIHJldHVyblBhcnRpYWxEYXRhOiB0cnVlLFxuICAgICAgbm90aWZ5T25OZXR3b3JrU3RhdHVzQ2hhbmdlOiB0cnVlLCAvLyB0byBnZXQgYWxsIHVwZGF0ZXMgb24gbG9hZGluZyBzdGF0ZVxuICAgICAgY29udGV4dDoge1xuICAgICAgICAuLi5jcmVhdGVBcG9sbG9Db250ZXh0RXJyb3JUaXRsZSh0aGlzLm9wZXJhdGlvbk5hbWUpLFxuICAgICAgICAuLi5jcmVhdGVBcG9sbG9Db250ZXh0SWdub3JlRXJyb3JNZXNzYWdlKFxuICAgICAgICAgIHRoaXMub3B0aW9ucz8uaWdub3JlRXJyb3JNZXNzYWdlICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgID8gdGhpcy5vcHRpb25zLmlnbm9yZUVycm9yTWVzc2FnZVxuICAgICAgICAgICAgOiBERUZBVUxUX09QVElPTlMuaWdub3JlRXJyb3JNZXNzYWdlID8/IGZhbHNlLFxuICAgICAgICApLFxuICAgICAgICAuLi5jcmVhdGVBcG9sbG9Db250ZXh0UmV0cnlhYmxlKFxuICAgICAgICAgIHRoaXMub3B0aW9ucz8ucmV0cnlhYmxlICE9PSB1bmRlZmluZWQgPyB0aGlzLm9wdGlvbnM/LnJldHJ5YWJsZSA6IERFRkFVTFRfT1BUSU9OUy5yZXRyeWFibGUgPz8gdHJ1ZSxcbiAgICAgICAgKSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICB1cGRhdGUodXBkYXRlVmFyaWFibGVzOiBVcGRhdGVWYXJpYWJsZXMpOiB2b2lkIHtcbiAgICB0aGlzLnZhcmlhYmxlcyA9IHRoaXMuY3JlYXRlVmFyaWFibGVzKHVwZGF0ZVZhcmlhYmxlcyk7XG4gICAgaWYgKCF0aGlzLmluaXRpYWxpemVkJC5nZXRWYWx1ZSgpKSB7XG4gICAgICB0aGlzLmluaXRpYWxpemUoKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuaXNJbkVycm9yU3RhdGUpIHtcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpO1xuICAgIH1cbiAgICBpZiAodGhpcy5xdWVyeVJlZiAmJiB0aGlzLnZhcmlhYmxlcykge1xuICAgICAgdGhpcy5xdWVyeVJlZi5zZXRWYXJpYWJsZXModGhpcy52YXJpYWJsZXMpO1xuICAgIH1cbiAgfVxuXG4gIHJlZmV0Y2godXBkYXRlVmFyaWFibGVzOiBVcGRhdGVWYXJpYWJsZXMpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5xdWVyeVJlZikge1xuICAgICAgdGhpcy5xdWVyeVJlZi5vcHRpb25zLmNvbnRleHQgPSB7XG4gICAgICAgIC4uLnRoaXMucXVlcnlSZWYub3B0aW9ucy5jb250ZXh0LFxuICAgICAgICAuLi5jcmVhdGVBcG9sbG9Db250ZXh0SWdub3JlRXJyb3JNZXNzYWdlKHRydWUpLFxuICAgICAgfTtcbiAgICB9XG4gICAgdGhpcy52YXJpYWJsZXMgPSB0aGlzLmNyZWF0ZVZhcmlhYmxlcyh1cGRhdGVWYXJpYWJsZXMpO1xuICAgIHRoaXMucXVlcnlSZWY/LnJlZmV0Y2godGhpcy52YXJpYWJsZXMpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGluaXRMb2FkaW5nKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnF1ZXJ5UmVmKSB7XG4gICAgICB0aGlzLmxvYWRpbmdJbnRlcm5hbCQgPSB0aGlzLnF1ZXJ5UmVmLnZhbHVlQ2hhbmdlcy5waXBlKFxuICAgICAgICAvLyB3ZSBpZ25vcmUgcmVmZXRjaCBsb2FkaW5ncyBiZWZvcmUgaXQgY2F1c2VzIGJhZCB1eC5cbiAgICAgICAgZmlsdGVyKChxdWVyeVJlcykgPT4gcXVlcnlSZXMubmV0d29ya1N0YXR1cyAhPT0gTmV0d29ya1N0YXR1cy5yZWZldGNoKSxcbiAgICAgICAgbWFwKChxdWVyeVJlcykgPT4gcXVlcnlSZXMubG9hZGluZyB8fCBxdWVyeVJlcy5lcnJvciAhPT0gdW5kZWZpbmVkKSxcbiAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBvZihmYWxzZSkpLFxuICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgaW5pdEhhc0Vycm9yKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnF1ZXJ5UmVmKSB7XG4gICAgICBjb25zdCByZWYgPSB0aGlzLnF1ZXJ5UmVmO1xuICAgICAgdGhpcy5oYXNFcnJvckludGVybmFsJCA9IHJlZi52YWx1ZUNoYW5nZXMucGlwZShcbiAgICAgICAgbWFwKChxdWVyeVJlcykgPT4gdGhpcy5oYXNFcnJvcihxdWVyeVJlcykpLFxuICAgICAgICBjYXRjaEVycm9yKCgpID0+IG9mKHRydWUpKSxcbiAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgICAgdGFwKChoYXNFcnJvcikgPT4gKHRoaXMuaXNJbkVycm9yU3RhdGUgPSBoYXNFcnJvcikpLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgaGFzRXJyb3IocXVlcnlSZXM6IEFwb2xsb1F1ZXJ5UmVzdWx0PFF1ZXJ5Pik6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoXG4gICAgICBxdWVyeVJlcy5lcnJvciAhPT0gdW5kZWZpbmVkIHx8IHF1ZXJ5UmVzLmVycm9ycyAhPT0gdW5kZWZpbmVkIHx8IHF1ZXJ5UmVzLm5ldHdvcmtTdGF0dXMgPT09IE5ldHdvcmtTdGF0dXMuZXJyb3JcbiAgICApO1xuICB9XG59XG4iXX0=