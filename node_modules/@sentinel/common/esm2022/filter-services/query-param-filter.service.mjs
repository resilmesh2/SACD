import { ActivatedRoute } from '@angular/router';
import { deslugify, deslugifyTimestamp, isArray, isDate, QueryParamsNavigationQueueService, slugify, slugifyDate, } from '@sentinel/common/utils';
import { combineLatest, from, merge } from 'rxjs';
import { concatMap, distinctUntilChanged, map, shareReplay, skip, tap } from 'rxjs/operators';
import { FilterService } from './filter.service';
import { inject } from '@angular/core';
export class QueryParamFilterService extends FilterService {
    constructor(ignoredKeys = [], ignoredActiveFilterKeys = ignoredKeys) {
        super(ignoredKeys, ignoredActiveFilterKeys);
        this.queryParamsQueueService = inject(QueryParamsNavigationQueueService);
        this.activatedRoute = inject(ActivatedRoute);
        this.filter$ = this.createFilterObservable();
    }
    toQueryParams(filter) {
        const params = {};
        const entries = Object.entries(filter);
        entries
            .filter((entry) => !this.ignoredKeys.map((key) => key.toString()).includes(entry[0]))
            .forEach((entry) => {
            if (isDate(entry[1])) {
                params[entry[0]] = this.slugifyDate(entry[1]);
            }
            else if (isArray(entry[1])) {
                params[entry[0]] = entry[1].map((entry) => this.slugify(entry?.toString()));
            }
            else {
                params[entry[0]] = this.slugify(entry[1]?.toString());
            }
        });
        return params;
    }
    updateQueryParams(filter) {
        return from(this.queryParamsQueueService.enqueue(this.toQueryParams(filter)));
    }
    slugify(value) {
        return slugify(value);
    }
    slugifyDate(value) {
        return slugifyDate(value);
    }
    deslugify(value) {
        return deslugify(value);
    }
    deslugifyTimestamp(value) {
        return deslugifyTimestamp(value);
    }
    getParamValue(paramMap, key) {
        return paramMap.get(key.toString());
    }
    createFilterObservable() {
        const fromRoute$ = this.fromRoute().pipe(tap((filter) => this.updateAndSubmit(filter)));
        const fromSubject$ = this.createFilterSubjectObservable();
        return merge(fromSubject$, fromRoute$).pipe(distinctUntilChanged((prev, curr) => this.areFilterKeysEqual(prev, curr, true)), concatMap((filter) => this.updateQueryParams(filter).pipe(map(() => filter))), shareReplay({ refCount: true }));
    }
    createFilterSubjectObservable() {
        // skip subject init from route
        return this.filterSubject$.asObservable().pipe(shareReplay({ refCount: true }), skip(1));
    }
    fromRoute() {
        return combineLatest([
            this.activatedRoute.queryParamMap,
            this.activatedRoute.paramMap,
            this.activatedRoute.data,
        ]).pipe(concatMap((routeAsyncAttrs) => this.createFilterFromRoute(routeAsyncAttrs[0], routeAsyncAttrs[1], routeAsyncAttrs[2])));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktcGFyYW0tZmlsdGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9zZW50aW5lbC1jb21tb24vZmlsdGVyLXNlcnZpY2VzL3NyYy9xdWVyeS1wYXJhbS1maWx0ZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsY0FBYyxFQUEwQixNQUFNLGlCQUFpQixDQUFDO0FBQ3pFLE9BQU8sRUFDTCxTQUFTLEVBQ1Qsa0JBQWtCLEVBQ2xCLE9BQU8sRUFDUCxNQUFNLEVBRU4saUNBQWlDLEVBQ2pDLE9BQU8sRUFDUCxXQUFXLEdBQ1osTUFBTSx3QkFBd0IsQ0FBQztBQUNoQyxPQUFPLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDOUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5RixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUV2QyxNQUFNLE9BQWdCLHVCQUErQyxTQUFRLGFBQXFCO0lBS2hHLFlBQ0UsY0FBbUMsRUFBRSxFQUNyQywwQkFBK0MsV0FBVztRQUUxRCxLQUFLLENBQUMsV0FBVyxFQUFFLHVCQUF1QixDQUFDLENBQUM7UUFQcEMsNEJBQXVCLEdBQUcsTUFBTSxDQUFDLGlDQUFpQyxDQUFDLENBQUM7UUFDcEUsbUJBQWMsR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUM7UUFPaEQsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztJQUMvQyxDQUFDO0lBR1MsYUFBYSxDQUFDLE1BQWM7UUFDcEMsTUFBTSxNQUFNLEdBQVcsRUFBRSxD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QUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFDN0UsV0FBVyxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBQ2hDLENBQUM7SUFDSixDQUFDO0lBRU8sNkJBQTZCO1FBQ25DLCtCQUErQjtRQUMvQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzNGLENBQUM7SUFFTyxTQUFTO1FBQ2YsT0FBTyxhQUFhLENBQUM7WUFDbkIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhO1lBQ2pDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUTtZQUM1QixJQUFJLENBQUMsY0FBYyxDQUFDLElBQUk7U0FDekIsQ0FBQyxDQUFDLElBQUksQ0FDTCxTQUFTLENBQUMsQ0FBQyxlQUFlLEVBQUUsRUFBRSxDQUM1QixJQUFJLENBQUMscUJBQXFCLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxFQUFFLGVBQWUsQ0FBQyxDQUFDLENBQUMsRUFBRSxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FDdkYsQ0FDRixDQUFDO0lBQ0osQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUsIERhdGEsIFBhcmFtTWFwLCBQYXJhbXMgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHtcbiAgZGVzbHVnaWZ5LFxuICBkZXNsdWdpZnlUaW1lc3RhbXAsXG4gIGlzQXJyYXksXG4gIGlzRGF0ZSxcbiAgT3B0aW9uYWwsXG4gIFF1ZXJ5UGFyYW1zTmF2aWdhdGlvblF1ZXVlU2VydmljZSxcbiAgc2x1Z2lmeSxcbiAgc2x1Z2lmeURhdGUsXG59IGZyb20gJ0BzZW50aW5lbC9jb21tb24vdXRpbHMnO1xuaW1wb3J0IHsgY29tYmluZUxhdGVzdCwgZnJvbSwgbWVyZ2UsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNvbmNhdE1hcCwgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCwgc2hhcmVSZXBsYXksIHNraXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEZpbHRlclNlcnZpY2UgfSBmcm9tICcuL2ZpbHRlci5zZXJ2aWNlJztcbmltcG9ydCB7IGluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUXVlcnlQYXJhbUZpbHRlclNlcnZpY2U8RmlsdGVyIGV4dGVuZHMgb2JqZWN0PiBleHRlbmRzIEZpbHRlclNlcnZpY2U8RmlsdGVyPiB7XG4gIGZpbHRlciQ6IE9ic2VydmFibGU8RmlsdGVyPjtcbiAgcHJvdGVjdGVkIHF1ZXJ5UGFyYW1zUXVldWVTZXJ2aWNlID0gaW5qZWN0KFF1ZXJ5UGFyYW1zTmF2aWdhdGlvblF1ZXVlU2VydmljZSk7XG4gIHByb3RlY3RlZCBhY3RpdmF0ZWRSb3V0ZSA9IGluamVjdChBY3RpdmF0ZWRSb3V0ZSk7XG5cbiAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKFxuICAgIGlnbm9yZWRLZXlzOiBBcnJheTxrZXlvZiBGaWx0ZXI+ID0gW10sXG4gICAgaWdub3JlZEFjdGl2ZUZpbHRlcktleXM6IEFycmF5PGtleW9mIEZpbHRlcj4gPSBpZ25vcmVkS2V5cyxcbiAgKSB7XG4gICAgc3VwZXIoaWdub3JlZEtleXMsIGlnbm9yZWRBY3RpdmVGaWx0ZXJLZXlzKTtcbiAgICB0aGlzLmZpbHRlciQgPSB0aGlzLmNyZWF0ZUZpbHRlck9ic2VydmFibGUoKTtcbiAgfVxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgY3JlYXRlRmlsdGVyRnJvbVJvdXRlKHF1ZXJ5UGFyYW1NYXA6IFBhcmFtTWFwLCBwYXJhbU1hcDogUGFyYW1NYXAsIGRhdGE6IERhdGEpOiBPYnNlcnZhYmxlPEZpbHRlcj47XG5cbiAgcHJvdGVjdGVkIHRvUXVlcnlQYXJhbXMoZmlsdGVyOiBGaWx0ZXIpOiBQYXJhbXMge1xuICAgIGNvbnN0IHBhcmFtczogUGFyYW1zID0ge307XG4gICAgY29uc3QgZW50cmllcyA9IE9iamVjdC5lbnRyaWVzKGZpbHRlcik7XG4gICAgZW50cmllc1xuICAgICAgLmZpbHRlcigoZW50cnkpID0+ICF0aGlzLmlnbm9yZWRLZXlzLm1hcCgoa2V5KSA9PiBrZXkudG9TdHJpbmcoKSkuaW5jbHVkZXMoZW50cnlbMF0pKVxuICAgICAgLmZvckVhY2goKGVudHJ5KSA9PiB7XG4gICAgICAgIGlmIChpc0RhdGUoZW50cnlbMV0pKSB7XG4gICAgICAgICAgcGFyYW1zW2VudHJ5WzBdXSA9IHRoaXMuc2x1Z2lmeURhdGUoZW50cnlbMV0pO1xuICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkoZW50cnlbMV0pKSB7XG4gICAgICAgICAgcGFyYW1zW2VudHJ5WzBdXSA9IGVudHJ5WzFdLm1hcCgoZW50cnkpID0+IHRoaXMuc2x1Z2lmeShlbnRyeT8udG9TdHJpbmcoKSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHBhcmFtc1tlbnRyeVswXV0gPSB0aGlzLnNsdWdpZnkoZW50cnlbMV0/LnRvU3RyaW5nKCkpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICByZXR1cm4gcGFyYW1zO1xuICB9XG5cbiAgcHJvdGVjdGVkIHVwZGF0ZVF1ZXJ5UGFyYW1zKGZpbHRlcjogRmlsdGVyKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIGZyb20odGhpcy5xdWVyeVBhcmFtc1F1ZXVlU2VydmljZS5lbnF1ZXVlKHRoaXMudG9RdWVyeVBhcmFtcyhmaWx0ZXIpKSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgc2x1Z2lmeSh2YWx1ZTogc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbCk6IE9wdGlvbmFsPHN0cmluZz4ge1xuICAgIHJldHVybiBzbHVnaWZ5KHZhbHVlKTtcbiAgfVxuICBwcm90ZWN0ZWQgc2x1Z2lmeURhdGUodmFsdWU6IERhdGUpOiBudW1iZXIge1xuICAgIHJldHVybiBzbHVnaWZ5RGF0ZSh2YWx1ZSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZGVzbHVnaWZ5KHZhbHVlOiBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsKTogT3B0aW9uYWw8c3RyaW5nPiB7XG4gICAgcmV0dXJuIGRlc2x1Z2lmeSh2YWx1ZSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZGVzbHVnaWZ5VGltZXN0YW1wKHZhbHVlOiBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsKTogT3B0aW9uYWw8RGF0ZT4ge1xuICAgIHJldHVybiBkZXNsdWdpZnlUaW1lc3RhbXAodmFsdWUpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldFBhcmFtVmFsdWUocGFyYW1NYXA6IFBhcmFtTWFwLCBrZXk6IGtleW9mIEZpbHRlcik6IHN0cmluZyB8IG51bGwge1xuICAgIHJldHVybiBwYXJhbU1hcC5nZXQoa2V5LnRvU3RyaW5nKCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVGaWx0ZXJPYnNlcnZhYmxlKCk6IE9ic2VydmFibGU8RmlsdGVyPiB7XG4gICAgY29uc3QgZnJvbVJvdXRlJCA9IHRoaXMuZnJvbVJvdXRlKCkucGlwZSh0YXAoKGZpbHRlcikgPT4gdGhpcy51cGRhdGVBbmRTdWJtaXQoZmlsdGVyKSkpO1xuICAgIGNvbnN0IGZyb21TdWJqZWN0JCA9IHRoaXMuY3JlYXRlRmlsdGVyU3ViamVjdE9ic2VydmFibGUoKTtcblxuICAgIHJldHVybiBtZXJnZShmcm9tU3ViamVjdCQsIGZyb21Sb3V0ZSQpLnBpcGUoXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgocHJldiwgY3VycikgPT4gdGhpcy5hcmVGaWx0ZXJLZXlzRXF1YWwocHJldiwgY3VyciwgdHJ1ZSkpLFxuICAgICAgY29uY2F0TWFwKChmaWx0ZXIpID0+IHRoaXMudXBkYXRlUXVlcnlQYXJhbXMoZmlsdGVyKS5waXBlKG1hcCgoKSA9PiBmaWx0ZXIpKSksXG4gICAgICBzaGFyZVJlcGxheSh7IHJlZkNvdW50OiB0cnVlIH0pLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUZpbHRlclN1YmplY3RPYnNlcnZhYmxlKCk6IE9ic2VydmFibGU8RmlsdGVyPiB7XG4gICAgLy8gc2tpcCBzdWJqZWN0IGluaXQgZnJvbSByb3V0ZVxuICAgIHJldHVybiB0aGlzLmZpbHRlclN1YmplY3QkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoc2hhcmVSZXBsYXkoeyByZWZDb3VudDogdHJ1ZSB9KSwgc2tpcCgxKSk7XG4gIH1cblxuICBwcml2YXRlIGZyb21Sb3V0ZSgpOiBPYnNlcnZhYmxlPEZpbHRlcj4ge1xuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFtcbiAgICAgIHRoaXMuYWN0aXZhdGVkUm91dGUucXVlcnlQYXJhbU1hcCxcbiAgICAgIHRoaXMuYWN0aXZhdGVkUm91dGUucGFyYW1NYXAsXG4gICAgICB0aGlzLmFjdGl2YXRlZFJvdXRlLmRhdGEsXG4gICAgXSkucGlwZShcbiAgICAgIGNvbmNhdE1hcCgocm91dGVBc3luY0F0dHJzKSA9PlxuICAgICAgICB0aGlzLmNyZWF0ZUZpbHRlckZyb21Sb3V0ZShyb3V0ZUFzeW5jQXR0cnNbMF0sIHJvdXRlQXN5bmNBdHRyc1sxXSwgcm91dGVBc3luY0F0dHJzWzJdKSxcbiAgICAgICksXG4gICAgKTtcbiAgfVxufVxuIl19