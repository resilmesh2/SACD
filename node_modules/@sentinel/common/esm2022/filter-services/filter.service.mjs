import equal from 'fast-deep-equal/es6';
import { BehaviorSubject } from 'rxjs';
import { distinctUntilChanged, map, shareReplay, tap } from 'rxjs/operators';
import { isArray } from '@sentinel/common/utils';
export class FilterService {
    constructor(ignoredKeys = [], ignoredActiveFilterKeys = ignoredKeys) {
        this.ignoredKeys = ignoredKeys;
        this.ignoredActiveFilterKeys = ignoredActiveFilterKeys;
        this.EMPTY_FILTER = this.createEmptyFilter();
        this.filterLocalStateSubject$ = new BehaviorSubject(this.EMPTY_FILTER);
        this.filterSubject$ = new BehaviorSubject(this.filterLocalStateSubject$.getValue());
        this.filterLocalState$ = this.filterLocalStateSubject$.asObservable().pipe(distinctUntilChanged((prev, curr) => equal(prev, curr)), shareReplay({ refCount: true }));
        this.filter$ = this.filterSubject$.asObservable().pipe(distinctUntilChanged((prev, curr) => equal(prev, curr)), tap((filter) => this.filterLocalStateSubject$.next(filter), shareReplay({ refCount: true })));
        this.isEmpty$ = this.filter$.pipe(map((filter) => this.areFilterKeysEqual(filter, this.EMPTY_FILTER)), distinctUntilChanged());
        this.activeFiltersCount$ = this.filterLocalState$.pipe(map((filter) => this.calculateActiveFiltersCount(filter)), distinctUntilChanged());
    }
    get() {
        return this.filterSubject$.getValue();
    }
    update(filter) {
        const curr = { ...this.filterLocalStateSubject$.getValue() };
        this.filterLocalStateSubject$.next({ ...curr, ...filter });
    }
    updateAndSubmit(filter) {
        this.update(filter);
        this.submit();
    }
    submit() {
        this.filterSubject$.next(this.filterLocalStateSubject$.getValue());
    }
    clear() {
        const currFilter = this.get();
        const emptyFilter = { ...this.EMPTY_FILTER };
        this.ignoredKeys.forEach((ignoredKey) => {
            if (currFilter[ignoredKey] !== undefined && currFilter[ignoredKey] !== null) {
                emptyFilter[ignoredKey] = currFilter[ignoredKey];
            }
        });
        this.filterLocalStateSubject$.next(emptyFilter);
        this.submit();
    }
    set(filter) {
        this.filterLocalStateSubject$.next(filter);
    }
    areFilterKeysEqual(prev, curr, compareIgnoredKeys = false) {
        const prevCopy = { ...prev };
        const currCopy = { ...curr };
        if (!compareIgnoredKeys) {
            this.ignoredKeys.forEach((ignoredKey) => {
                delete prevCopy[ignoredKey];
                delete currCopy[ignoredKey];
            });
        }
        return equal(currCopy, prevCopy);
    }
    calculateActiveFiltersCount(filter) {
        if (typeof filter === 'object') {
            let count = 0;
            const narrowedFilter = filter;
            Object.keys(narrowedFilter).forEach((key) => {
                if (!this.ignoredActiveFilterKeys.includes(key) &&
                    narrowedFilter[key] !== undefined &&
                    narrowedFilter[key] !== null &&
                    narrowedFilter[key] !== '' &&
                    (!isArray(narrowedFilter[key]) || narrowedFilter[key].length > 0)) {
                    count++;
                }
            });
            return count;
        }
        else {
            return 0;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9zZW50aW5lbC1jb21tb24vZmlsdGVyLXNlcnZpY2VzL3NyYy9maWx0ZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssTUFBTSxxQkFBcUIsQ0FBQztBQUN4QyxPQUFPLEVBQUUsZUFBZSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUVqRCxNQUFNLE9BQWdCLGFBQWE7SUFjakMsWUFDRSxjQUFtQyxFQUFFLEVBQ3JDLDBCQUErQyxXQUFXO1FBRTFELElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyx1QkFBdUIsR0FBRyx1QkFBdUIsQ0FBQztRQUN2RCxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQzdDLElBQUksQ0FBQyx3QkFBd0IsR0FBRyxJQUFJLGVBQWUsQ0FBUyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDL0UsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLGVBQWUsQ0FBUyxJQUFJLENBQUMsd0JBQXdCLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUM1RixJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFlBQVksRUFBRSxDQUFDLElBQUksQ0FDeEUsb0JBQW9CLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLEVBQ3ZELFdBQVcsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUs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cXVhbC9lczYnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwLCBzaGFyZVJlcGxheSwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgaXNBcnJheSB9IGZyb20gJ0BzZW50aW5lbC9jb21tb24vdXRpbHMnO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgRmlsdGVyU2VydmljZTxGaWx0ZXI+IHtcbiAgcmVhZG9ubHkgRU1QVFlfRklMVEVSOiBGaWx0ZXI7XG4gIHByb3RlY3RlZCBmaWx0ZXJMb2NhbFN0YXRlU3ViamVjdCQ6IEJlaGF2aW9yU3ViamVjdDxGaWx0ZXI+O1xuICBwcm90ZWN0ZWQgZmlsdGVyU3ViamVjdCQ6IEJlaGF2aW9yU3ViamVjdDxGaWx0ZXI+O1xuICBmaWx0ZXJMb2NhbFN0YXRlJDogT2JzZXJ2YWJsZTxGaWx0ZXI+O1xuICBmaWx0ZXIkOiBPYnNlcnZhYmxlPEZpbHRlcj47XG4gIGFjdGl2ZUZpbHRlcnNDb3VudCQ6IE9ic2VydmFibGU8bnVtYmVyPjtcbiAgaXNFbXB0eSQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG4gIC8qXG4gIEtleXMgd2hpY2ggYXJlIGlnbm9yZWQgaW4gZXZhbHVhdGlvbiBvZiBpc0VtcHR5IGZpbHRlclxuICAgKi9cbiAgaWdub3JlZEtleXM6IEFycmF5PGtleW9mIEZpbHRlcj47XG4gIGlnbm9yZWRBY3RpdmVGaWx0ZXJLZXlzOiBBcnJheTxrZXlvZiBGaWx0ZXI+O1xuXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3RvcihcbiAgICBpZ25vcmVkS2V5czogQXJyYXk8a2V5b2YgRmlsdGVyPiA9IFtdLFxuICAgIGlnbm9yZWRBY3RpdmVGaWx0ZXJLZXlzOiBBcnJheTxrZXlvZiBGaWx0ZXI+ID0gaWdub3JlZEtleXMsXG4gICkge1xuICAgIHRoaXMuaWdub3JlZEtleXMgPSBpZ25vcmVkS2V5cztcbiAgICB0aGlzLmlnbm9yZWRBY3RpdmVGaWx0ZXJLZXlzID0gaWdub3JlZEFjdGl2ZUZpbHRlcktleXM7XG4gICAgdGhpcy5FTVBUWV9GSUxURVIgPSB0aGlzLmNyZWF0ZUVtcHR5RmlsdGVyKCk7XG4gICAgdGhpcy5maWx0ZXJMb2NhbFN0YXRlU3ViamVjdCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEZpbHRlcj4odGhpcy5FTVBUWV9GSUxURVIpO1xuICAgIHRoaXMuZmlsdGVyU3ViamVjdCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEZpbHRlcj4odGhpcy5maWx0ZXJMb2NhbFN0YXRlU3ViamVjdCQuZ2V0VmFsdWUoKSk7XG4gICAgdGhpcy5maWx0ZXJMb2NhbFN0YXRlJCA9IHRoaXMuZmlsdGVyTG9jYWxTdGF0ZVN1YmplY3QkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgocHJldiwgY3VycikgPT4gZXF1YWwocHJldiwgY3VycikpLFxuICAgICAgc2hhcmVSZXBsYXkoeyByZWZDb3VudDogdHJ1ZSB9KSxcbiAgICApO1xuICAgIHRoaXMuZmlsdGVyJCA9IHRoaXMuZmlsdGVyU3ViamVjdCQuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKChwcmV2LCBjdXJyKSA9PiBlcXVhbChwcmV2LCBjdXJyKSksXG4gICAgICB0YXAoKGZpbHRlcikgPT4gdGhpcy5maWx0ZXJMb2NhbFN0YXRlU3ViamVjdCQubmV4dChmaWx0ZXIpLCBzaGFyZVJlcGxheSh7IHJlZkNvdW50OiB0cnVlIH0pKSxcbiAgICApO1xuICAgIHRoaXMuaXNFbXB0eSQgPSB0aGlzLmZpbHRlciQucGlwZShcbiAgICAgIG1hcCgoZmlsdGVyKSA9PiB0aGlzLmFyZUZpbHRlcktleXNFcXVhbChmaWx0ZXIsIHRoaXMuRU1QVFlfRklMVEVSKSksXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICk7XG4gICAgdGhpcy5hY3RpdmVGaWx0ZXJzQ291bnQkID0gdGhpcy5maWx0ZXJMb2NhbFN0YXRlJC5waXBlKFxuICAgICAgbWFwKChmaWx0ZXIpID0+IHRoaXMuY2FsY3VsYXRlQWN0aXZlRmlsdGVyc0NvdW50KGZpbHRlcikpLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICApO1xuICB9XG5cbiAgZ2V0KCk6IEZpbHRlciB7XG4gICAgcmV0dXJuIHRoaXMuZmlsdGVyU3ViamVjdCQuZ2V0VmFsdWUoKTtcbiAgfVxuXG4gIHVwZGF0ZShmaWx0ZXI6IFBhcnRpYWw8RmlsdGVyPik6IHZvaWQge1xuICAgIGNvbnN0IGN1cnIgPSB7IC4uLnRoaXMuZmlsdGVyTG9jYWxTdGF0ZVN1YmplY3QkLmdldFZhbHVlKCkgfTtcbiAgICB0aGlzLmZpbHRlckxvY2FsU3RhdGVTdWJqZWN0JC5uZXh0KHsgLi4uY3VyciwgLi4uZmlsdGVyIH0pO1xuICB9XG5cbiAgdXBkYXRlQW5kU3VibWl0KGZpbHRlcjogUGFydGlhbDxGaWx0ZXI+KTogdm9pZCB7XG4gICAgdGhpcy51cGRhdGUoZmlsdGVyKTtcbiAgICB0aGlzLnN1Ym1pdCgpO1xuICB9XG5cbiAgc3VibWl0KCk6IHZvaWQge1xuICAgIHRoaXMuZmlsdGVyU3ViamVjdCQubmV4dCh0aGlzLmZpbHRlckxvY2FsU3RhdGVTdWJqZWN0JC5nZXRWYWx1ZSgpKTtcbiAgfVxuXG4gIGNsZWFyKCk6IHZvaWQge1xuICAgIGNvbnN0IGN1cnJGaWx0ZXIgPSB0aGlzLmdldCgpO1xuICAgIGNvbnN0IGVtcHR5RmlsdGVyID0geyAuLi50aGlzLkVNUFRZX0ZJTFRFUiB9O1xuICAgIHRoaXMuaWdub3JlZEtleXMuZm9yRWFjaCgoaWdub3JlZEtleSkgPT4ge1xuICAgICAgaWYgKGN1cnJGaWx0ZXJbaWdub3JlZEtleV0gIT09IHVuZGVmaW5lZCAmJiBjdXJyRmlsdGVyW2lnbm9yZWRLZXldICE9PSBudWxsKSB7XG4gICAgICAgIGVtcHR5RmlsdGVyW2lnbm9yZWRLZXldID0gY3VyckZpbHRlcltpZ25vcmVkS2V5XTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLmZpbHRlckxvY2FsU3RhdGVTdWJqZWN0JC5uZXh0KGVtcHR5RmlsdGVyKTtcbiAgICB0aGlzLnN1Ym1pdCgpO1xuICB9XG5cbiAgc2V0KGZpbHRlcjogRmlsdGVyKTogdm9pZCB7XG4gICAgdGhpcy5maWx0ZXJMb2NhbFN0YXRlU3ViamVjdCQubmV4dChmaWx0ZXIpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGFic3RyYWN0IGNyZWF0ZUVtcHR5RmlsdGVyKCk6IEZpbHRlcjtcblxuICBwcm90ZWN0ZWQgYXJlRmlsdGVyS2V5c0VxdWFsKHByZXY6IEZpbHRlciwgY3VycjogRmlsdGVyLCBjb21wYXJlSWdub3JlZEtleXMgPSBmYWxzZSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHByZXZDb3B5ID0geyAuLi5wcmV2IH07XG4gICAgY29uc3QgY3VyckNvcHkgPSB7IC4uLmN1cnIgfTtcbiAgICBpZiAoIWNvbXBhcmVJZ25vcmVkS2V5cykge1xuICAgICAgdGhpcy5pZ25vcmVkS2V5cy5mb3JFYWNoKChpZ25vcmVkS2V5KSA9PiB7XG4gICAgICAgIGRlbGV0ZSBwcmV2Q29weVtpZ25vcmVkS2V5XTtcbiAgICAgICAgZGVsZXRlIGN1cnJDb3B5W2lnbm9yZWRLZXldO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBlcXVhbChjdXJyQ29weSwgcHJldkNvcHkpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGNhbGN1bGF0ZUFjdGl2ZUZpbHRlcnNDb3VudChmaWx0ZXI6IEZpbHRlcik6IG51bWJlciB7XG4gICAgaWYgKHR5cGVvZiBmaWx0ZXIgPT09ICdvYmplY3QnKSB7XG4gICAgICBsZXQgY291bnQgPSAwO1xuICAgICAgY29uc3QgbmFycm93ZWRGaWx0ZXIgPSBmaWx0ZXIgYXMgeyBba2V5OiBzdHJpbmddOiB1bmtub3duIH07XG4gICAgICBPYmplY3Qua2V5cyhuYXJyb3dlZEZpbHRlcikuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAhdGhpcy5pZ25vcmVkQWN0aXZlRmlsdGVyS2V5cy5pbmNsdWRlcyhrZXkgYXMga2V5b2YgRmlsdGVyKSAmJlxuICAgICAgICAgIG5hcnJvd2VkRmlsdGVyW2tleV0gIT09IHVuZGVmaW5lZCAmJlxuICAgICAgICAgIG5hcnJvd2VkRmlsdGVyW2tleV0gIT09IG51bGwgJiZcbiAgICAgICAgICBuYXJyb3dlZEZpbHRlcltrZXldICE9PSAnJyAmJlxuICAgICAgICAgICghaXNBcnJheShuYXJyb3dlZEZpbHRlcltrZXldKSB8fCAobmFycm93ZWRGaWx0ZXJba2V5XSBhcyBBcnJheTx1bmtub3duPikubGVuZ3RoID4gMClcbiAgICAgICAgKSB7XG4gICAgICAgICAgY291bnQrKztcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gY291bnQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgfVxufVxuIl19