import { Inject, Injectable, Optional } from '@angular/core';
import { propertyOf, toQueryParams, } from '@sentinel/common/utils';
import { from } from 'rxjs';
import { concatMap, map, shareReplay, take, tap } from 'rxjs/operators';
import { INIT_PAGINATION_EVENT_BASE_TOKEN, MAX_PAGINATION_SIZE_TOKEN, PAGINATION_TYPE_TOKEN } from './pagination-token';
import { createPaginationManager, PaginationService } from './pagination.service';
import { CursorPaginationEvent, OffsetPaginationEvent } from '@sentinel/common/pagination';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "@sentinel/common/utils";
import * as i3 from "./pagination-base-init";
export class QueryParamPaginationService extends PaginationService {
    constructor(activatedRoute, queryParamsQueueService, initPaginationBase, paginationType, initMaxPaginationSize) {
        super(initPaginationBase, paginationType);
        this.activatedRoute = activatedRoute;
        this.queryParamsQueueService = queryParamsQueueService;
        this.initPaginationBase = initPaginationBase;
        this.paginationType = paginationType;
        this.initMaxPaginationSize = initMaxPaginationSize;
        if (!paginationType) {
            this.paginationType = 'cursor';
        }
        this.maxPaginationSize = initMaxPaginationSize ? initMaxPaginationSize : 100;
        this.pagination$ = this.createPaginationObservable();
    }
    updateQueryParams(pagination) {
        return from(this.queryParamsQueueService.enqueue(toQueryParams(pagination)));
    }
    createPaginationObservable() {
        return this.fromRoute().pipe(tap((pagination) => (this.paginationManager = createPaginationManager(this.INIT_PAGINATION.size, pagination, this.paginationType ?? 'cursor'))), concatMap(() => this.paginationManager.pagination$), concatMap((pagination) => this.updateQueryParams(pagination).pipe(map(() => pagination))), shareReplay({ refCount: true }));
    }
    fromRoute() {
        return this.activatedRoute.queryParamMap.pipe(take(1), map((paramMap) => this.paginationFromParamMap(paramMap)));
    }
    paginationFromParamMap(paramMap) {
        let pagination;
        if (this.paginationType === 'offset') {
            pagination = this.offsetPaginationFromParamMap(paramMap);
        }
        else if (this.paginationType === 'cursor') {
            pagination = this.cursorPaginationFromParamMap(paramMap);
        }
        return pagination ?? this.INIT_PAGINATION;
    }
    offsetPaginationFromParamMap(paramMap) {
        const paginationBase = this.paginationBaseFromParamMap(paramMap);
        const pageStr = paramMap.get('page');
        if (paginationBase && pageStr !== null) {
            const parsedPage = Number.parseInt(pageStr);
            if (Number.isInteger(parsedPage)) {
                const page = Math.max(parsedPage, 0);
                return new OffsetPaginationEvent(page, paginationBase.size, paginationBase.sort, paginationBase.sortDir);
            }
        }
        return undefined;
    }
    cursorPaginationFromParamMap(paramMap) {
        const paginationBase = this.paginationBaseFromParamMap(paramMap);
        const cursor = paramMap.get('cursor');
        if (paginationBase) {
            return new CursorPaginationEvent(cursor, paginationBase.size, paginationBase.sort, paginationBase.sortDir);
        }
        return undefined;
    }
    paginationBaseFromParamMap(paramMap) {
        const sizeStr = paramMap.get(propertyOf('size'));
        const sort = paramMap.get(propertyOf('sort'));
        const sortDir = paramMap.get(propertyOf('sortDir'));
        if (sizeStr !== null) {
            const parsedSize = Number.parseInt(sizeStr);
            if (Number.isInteger(parsedSize)) {
                const positiveSize = Math.max(parsedSize, 1);
                const size = Math.min(positiveSize, this.maxPaginationSize);
                if (sort !== null && sortDir !== null) {
                    return { size: size, sort, sortDir: sortDir === 'asc' ? 'asc' : 'desc' };
                }
                else {
                    return { size: size, sort: undefined, sortDir: undefined };
                }
            }
        }
        return undefined;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.0", ngImport: i0, type: QueryParamPaginationService, deps: [{ token: i1.ActivatedRoute }, { token: i2.QueryParamsNavigationQueueService }, { token: INIT_PAGINATION_EVENT_BASE_TOKEN, optional: true }, { token: PAGINATION_TYPE_TOKEN, optional: true }, { token: MAX_PAGINATION_SIZE_TOKEN, optional: true }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.0.0", ngImport: i0, type: QueryParamPaginationService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.0", ngImport: i0, type: QueryParamPaginationService, decorators: [{
            type: Injectable
        }], ctorParameters: () => [{ type: i1.ActivatedRoute }, { type: i2.QueryParamsNavigationQueueService }, { type: i3.PaginationBaseInit, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [INIT_PAGINATION_EVENT_BASE_TOKEN]
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [PAGINATION_TYPE_TOKEN]
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [MAX_PAGINATION_SIZE_TOKEN]
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktcGFyYW0tcGFnaW5hdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvc2VudGluZWwtY29tbW9uL3BhZ2luYXRpb24tc2VydmljZXMvc3JjL3F1ZXJ5LXBhcmFtLXBhZ2luYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFN0QsT0FBTyxFQUVMLFVBQVUsRUFFVixhQUFhLEdBQ2QsTUFBTSx3QkFBd0IsQ0FBQztBQUNoQyxPQUFPLEVBQUUsSUFBSSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHeEUsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLHlCQUF5QixFQUFFLHFCQUFxQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDeEgsT0FBTyxFQUFFLHVCQUF1QixFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFbEYsT0FBTyxFQUFFLHFCQUFxQixFQUFvQixxQkFBcUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDOzs7OztBQUc3RyxNQUFNLE9BQU8sMkJBQTRCLFNBQVEsaUJBQWlCO0lBRWhFLFlBQ1UsY0FBOEIsRUFDOUIsdUJBQTBELEVBQ08sa0JBQXVDLEVBQ2xELGNBQStCLEVBQzNCLHFCQUE4QjtRQUVoRyxLQUFLLENBQUMsa0JBQWtCLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFObEMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBbUM7UUFDTyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQXFCO1FBQ2xELG1CQUFjLEdBQWQsY0FBYyxDQUFpQjtRQUMzQiww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QUksSUFBSSxLQUFLLElBQUksSUFBSSxPQUFPLEtBQUssSUFBSSxFQUFFLENBQUM7b0JBQ3RDLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsT0FBTyxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDM0UsQ0FBQztxQkFBTSxDQUFDO29CQUNOLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxDQUFDO2dCQUM3RCxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDOzhHQTdGVSwyQkFBMkIsaUdBS2hCLGdDQUFnQyw2QkFDaEMscUJBQXFCLDZCQUNyQix5QkFBeUI7a0hBUHBDLDJCQUEyQjs7MkZBQTNCLDJCQUEyQjtrQkFEdkMsVUFBVTs7MEJBTU4sUUFBUTs7MEJBQUksTUFBTTsyQkFBQyxnQ0FBZ0M7OzBCQUNuRCxRQUFROzswQkFBSSxNQUFNOzJCQUFDLHFCQUFxQjs7MEJBQ3hDLFFBQVE7OzBCQUFJLE1BQU07MkJBQUMseUJBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUsIFBhcmFtTWFwIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7XG4gIE9wdGlvbmFsIGFzIE1heWJlLFxuICBwcm9wZXJ0eU9mLFxuICBRdWVyeVBhcmFtc05hdmlnYXRpb25RdWV1ZVNlcnZpY2UsXG4gIHRvUXVlcnlQYXJhbXMsXG59IGZyb20gJ0BzZW50aW5lbC9jb21tb24vdXRpbHMnO1xuaW1wb3J0IHsgZnJvbSwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY29uY2F0TWFwLCBtYXAsIHNoYXJlUmVwbGF5LCB0YWtlLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQYWdpbmF0aW9uQmFzZSB9IGZyb20gJy4vcGFnaW5hdGlvbi1iYXNlJztcbmltcG9ydCB7IFBhZ2luYXRpb25CYXNlSW5pdCB9IGZyb20gJy4vcGFnaW5hdGlvbi1iYXNlLWluaXQnO1xuaW1wb3J0IHsgSU5JVF9QQUdJTkFUSU9OX0VWRU5UX0JBU0VfVE9LRU4sIE1BWF9QQUdJTkFUSU9OX1NJWkVfVE9LRU4sIFBBR0lOQVRJT05fVFlQRV9UT0tFTiB9IGZyb20gJy4vcGFnaW5hdGlvbi10b2tlbic7XG5pbXBvcnQgeyBjcmVhdGVQYWdpbmF0aW9uTWFuYWdlciwgUGFnaW5hdGlvblNlcnZpY2UgfSBmcm9tICcuL3BhZ2luYXRpb24uc2VydmljZSc7XG5pbXBvcnQgeyBQYWdpbmF0aW9uVHlwZSB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgQ3Vyc29yUGFnaW5hdGlvbkV2ZW50LCBJUGFnaW5hdGlvbkV2ZW50LCBPZmZzZXRQYWdpbmF0aW9uRXZlbnQgfSBmcm9tICdAc2VudGluZWwvY29tbW9uL3BhZ2luYXRpb24nO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUXVlcnlQYXJhbVBhZ2luYXRpb25TZXJ2aWNlIGV4dGVuZHMgUGFnaW5hdGlvblNlcnZpY2Uge1xuICByZWFkb25seSBtYXhQYWdpbmF0aW9uU2l6ZTogbnVtYmVyO1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSxcbiAgICBwcml2YXRlIHF1ZXJ5UGFyYW1zUXVldWVTZXJ2aWNlOiBRdWVyeVBhcmFtc05hdmlnYXRpb25RdWV1ZVNlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChJTklUX1BBR0lOQVRJT05fRVZFTlRfQkFTRV9UT0tFTikgcHJvdGVjdGVkIHJlYWRvbmx5IGluaXRQYWdpbmF0aW9uQmFzZT86IFBhZ2luYXRpb25CYXNlSW5pdCxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KFBBR0lOQVRJT05fVFlQRV9UT0tFTikgcHJvdGVjdGVkIHJlYWRvbmx5IHBhZ2luYXRpb25UeXBlPzogUGFnaW5hdGlvblR5cGUsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChNQVhfUEFHSU5BVElPTl9TSVpFX1RPS0VOKSBwcm90ZWN0ZWQgcmVhZG9ubHkgaW5pdE1heFBhZ2luYXRpb25TaXplPzogbnVtYmVyLFxuICApIHtcbiAgICBzdXBlcihpbml0UGFnaW5hdGlvbkJhc2UsIHBhZ2luYXRpb25UeXBlKTtcbiAgICBpZiAoIXBhZ2luYXRpb25UeXBlKSB7XG4gICAgICB0aGlzLnBhZ2luYXRpb25UeXBlID0gJ2N1cnNvcic7XG4gICAgfVxuICAgIHRoaXMubWF4UGFnaW5hdGlvblNpemUgPSBpbml0TWF4UGFnaW5hdGlvblNpemUgPyBpbml0TWF4UGFnaW5hdGlvblNpemUgOiAxMDA7XG4gICAgdGhpcy5wYWdpbmF0aW9uJCA9IHRoaXMuY3JlYXRlUGFnaW5hdGlvbk9ic2VydmFibGUoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCB1cGRhdGVRdWVyeVBhcmFtcyhwYWdpbmF0aW9uOiBJUGFnaW5hdGlvbkV2ZW50KTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIGZyb20odGhpcy5xdWVyeVBhcmFtc1F1ZXVlU2VydmljZS5lbnF1ZXVlKHRvUXVlcnlQYXJhbXM8SVBhZ2luYXRpb25FdmVudD4ocGFnaW5hdGlvbikpKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUGFnaW5hdGlvbk9ic2VydmFibGUoKTogT2JzZXJ2YWJsZTxJUGFnaW5hdGlvbkV2ZW50PiB7XG4gICAgcmV0dXJuIHRoaXMuZnJvbVJvdXRlKCkucGlwZShcbiAgICAgIHRhcChcbiAgICAgICAgKHBhZ2luYXRpb24pID0+XG4gICAgICAgICAgKHRoaXMucGFnaW5hdGlvbk1hbmFnZXIgPSBjcmVhdGVQYWdpbmF0aW9uTWFuYWdlcihcbiAgICAgICAgICAgIHRoaXMuSU5JVF9QQUdJTkFUSU9OLnNpemUsXG4gICAgICAgICAgICBwYWdpbmF0aW9uLFxuICAgICAgICAgICAgdGhpcy5wYWdpbmF0aW9uVHlwZSA/PyAnY3Vyc29yJyxcbiAgICAgICAgICApKSxcbiAgICAgICksXG4gICAgICBjb25jYXRNYXAoKCkgPT4gdGhpcy5wYWdpbmF0aW9uTWFuYWdlci5wYWdpbmF0aW9uJCksXG4gICAgICBjb25jYXRNYXAoKHBhZ2luYXRpb24pID0+IHRoaXMudXBkYXRlUXVlcnlQYXJhbXMocGFnaW5hdGlvbikucGlwZShtYXAoKCkgPT4gcGFnaW5hdGlvbikpKSxcbiAgICAgIHNoYXJlUmVwbGF5KHsgcmVmQ291bnQ6IHRydWUgfSksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZnJvbVJvdXRlKCk6IE9ic2VydmFibGU8SVBhZ2luYXRpb25FdmVudD4ge1xuICAgIHJldHVybiB0aGlzLmFjdGl2YXRlZFJvdXRlLnF1ZXJ5UGFyYW1NYXAucGlwZShcbiAgICAgIHRha2UoMSksXG4gICAgICBtYXAoKHBhcmFtTWFwKSA9PiB0aGlzLnBhZ2luYXRpb25Gcm9tUGFyYW1NYXAocGFyYW1NYXApKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBwYWdpbmF0aW9uRnJvbVBhcmFtTWFwKHBhcmFtTWFwOiBQYXJhbU1hcCk6IElQYWdpbmF0aW9uRXZlbnQge1xuICAgIGxldCBwYWdpbmF0aW9uOiBNYXliZTxJUGFnaW5hdGlvbkV2ZW50PjtcbiAgICBpZiAodGhpcy5wYWdpbmF0aW9uVHlwZSA9PT0gJ29mZnNldCcpIHtcbiAgICAgIHBhZ2luYXRpb24gPSB0aGlzLm9mZnNldFBhZ2luYXRpb25Gcm9tUGFyYW1NYXAocGFyYW1NYXApO1xuICAgIH0gZWxzZSBpZiAodGhpcy5wYWdpbmF0aW9uVHlwZSA9PT0gJ2N1cnNvcicpIHtcbiAgICAgIHBhZ2luYXRpb24gPSB0aGlzLmN1cnNvclBhZ2luYXRpb25Gcm9tUGFyYW1NYXAocGFyYW1NYXApO1xuICAgIH1cbiAgICByZXR1cm4gcGFnaW5hdGlvbiA/PyB0aGlzLklOSVRfUEFHSU5BVElPTjtcbiAgfVxuXG4gIHByaXZhdGUgb2Zmc2V0UGFnaW5hdGlvbkZyb21QYXJhbU1hcChwYXJhbU1hcDogUGFyYW1NYXApOiBNYXliZTxJUGFnaW5hdGlvbkV2ZW50PiB7XG4gICAgY29uc3QgcGFnaW5hdGlvbkJhc2UgPSB0aGlzLnBhZ2luYXRpb25CYXNlRnJvbVBhcmFtTWFwKHBhcmFtTWFwKTtcbiAgICBjb25zdCBwYWdlU3RyID0gcGFyYW1NYXAuZ2V0KCdwYWdlJyk7XG4gICAgaWYgKHBhZ2luYXRpb25CYXNlICYmIHBhZ2VTdHIgIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IHBhcnNlZFBhZ2UgPSBOdW1iZXIucGFyc2VJbnQocGFnZVN0cik7XG4gICAgICBpZiAoTnVtYmVyLmlzSW50ZWdlcihwYXJzZWRQYWdlKSkge1xuICAgICAgICBjb25zdCBwYWdlID0gTWF0aC5tYXgocGFyc2VkUGFnZSwgMCk7XG4gICAgICAgIHJldHVybiBuZXcgT2Zmc2V0UGFnaW5hdGlvbkV2ZW50KHBhZ2UsIHBhZ2luYXRpb25CYXNlLnNpemUsIHBhZ2luYXRpb25CYXNlLnNvcnQsIHBhZ2luYXRpb25CYXNlLnNvcnREaXIpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBjdXJzb3JQYWdpbmF0aW9uRnJvbVBhcmFtTWFwKHBhcmFtTWFwOiBQYXJhbU1hcCk6IE1heWJlPElQYWdpbmF0aW9uRXZlbnQ+IHtcbiAgICBjb25zdCBwYWdpbmF0aW9uQmFzZSA9IHRoaXMucGFnaW5hdGlvbkJhc2VGcm9tUGFyYW1NYXAocGFyYW1NYXApO1xuICAgIGNvbnN0IGN1cnNvciA9IHBhcmFtTWFwLmdldCgnY3Vyc29yJyk7XG4gICAgaWYgKHBhZ2luYXRpb25CYXNlKSB7XG4gICAgICByZXR1cm4gbmV3IEN1cnNvclBhZ2luYXRpb25FdmVudChjdXJzb3IsIHBhZ2luYXRpb25CYXNlLnNpemUsIHBhZ2luYXRpb25CYXNlLnNvcnQsIHBhZ2luYXRpb25CYXNlLnNvcnREaXIpO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBwYWdpbmF0aW9uQmFzZUZyb21QYXJhbU1hcChwYXJhbU1hcDogUGFyYW1NYXApOiBNYXliZTxQYWdpbmF0aW9uQmFzZT4ge1xuICAgIGNvbnN0IHNpemVTdHIgPSBwYXJhbU1hcC5nZXQocHJvcGVydHlPZjxQYWdpbmF0aW9uQmFzZT4oJ3NpemUnKSk7XG4gICAgY29uc3Qgc29ydCA9IHBhcmFtTWFwLmdldChwcm9wZXJ0eU9mPFBhZ2luYXRpb25CYXNlPignc29ydCcpKTtcbiAgICBjb25zdCBzb3J0RGlyID0gcGFyYW1NYXAuZ2V0KHByb3BlcnR5T2Y8UGFnaW5hdGlvbkJhc2U+KCdzb3J0RGlyJykpO1xuICAgIGlmIChzaXplU3RyICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBwYXJzZWRTaXplID0gTnVtYmVyLnBhcnNlSW50KHNpemVTdHIpO1xuICAgICAgaWYgKE51bWJlci5pc0ludGVnZXIocGFyc2VkU2l6ZSkpIHtcbiAgICAgICAgY29uc3QgcG9zaXRpdmVTaXplID0gTWF0aC5tYXgocGFyc2VkU2l6ZSwgMSk7XG4gICAgICAgIGNvbnN0IHNpemUgPSBNYXRoLm1pbihwb3NpdGl2ZVNpemUsIHRoaXMubWF4UGFnaW5hdGlvblNpemUpO1xuICAgICAgICBpZiAoc29ydCAhPT0gbnVsbCAmJiBzb3J0RGlyICE9PSBudWxsKSB7XG4gICAgICAgICAgcmV0dXJuIHsgc2l6ZTogc2l6ZSwgc29ydCwgc29ydERpcjogc29ydERpciA9PT0gJ2FzYycgPyAnYXNjJyA6ICdkZXNjJyB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHNpemU6IHNpemUsIHNvcnQ6IHVuZGVmaW5lZCwgc29ydERpcjogdW5kZWZpbmVkIH07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxufVxuIl19