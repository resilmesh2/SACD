<h1>CSA Nodes</h1>
<sentinel-card [controls]="controls">
    <!-- Show spinner while loading data -->
  @if (dataLoading) {
    <ng-container>
      <mat-spinner></mat-spinner>
    </ng-container>
  } @else if (errorResponse && !dataLoading) {
    <!-- Show error message if there's an error -->
    <ng-container>
      <p class="error">
        <strong>Error fetching data from GraphQL API.</strong><br />
        <span>Error message: {{ errorResponse }}</span>
      </p>
    </ng-container>
  } @else if (emptyResponse && !dataLoading && !errorResponse) {
    <!-- Show no data message if the response is empty -->
    <ng-container>
      <p class="no-data">
        <strong>No available data.</strong>
      </p>
    </ng-container>
  } @else if (dataLoaded && !dataLoading && !emptyResponse) {
  <ng-container class="full-width-table">
    <div class="header-line">
      <mat-form-field subscriptSizing="dynamic">
        <input matInput [(ngModel)]="searchTerm" (keyup)="applyNameFilter()" placeholder="Search by IP address">
      </mat-form-field>

      <sentinel-button-with-icon
        color="primary"
        icon="filter_list_off"
        tooltip="Reset all filters"
        (click)="resetFilters()"
      >
        Reset Filters
      </sentinel-button-with-icon>

      <div class="total-assets">
        Total Number of Assets: {{ totalSortedServices() }}
      </div>  
    </div>

    <table mat-table [dataSource]="dataSource" class="mat-table" matSort matSortActive="final_criticality" matSortDisableClear matSortDirection="desc">
      <!-- IPs Column -->
      <ng-container matColumnDef="ips">
        <th mat-header-cell *matHeaderCellDef> IPs </th>
        <td mat-cell *matCellDef="let node" style="width: 30rem;">
          <div class="chips">
            @for (ip of node.ips || []; track ip; let index = $index) {
              <a (click)="navigateToNetworkNodeView(ip)" class="chip asset-link">
                {{ ip }}
              </a>
            }
          </div>
        </td>
      </ng-container>

      <!-- Topology Degree Column -->
      <!-- <ng-container matColumnDef="topology_degree_norm">
        <th mat-header-cell *matHeaderCellDef> Topology Degree </th>
        <td mat-cell *matCellDef="let node"> {{ node.topology_degree }} </td>
      </ng-container> -->

      <!-- Topology Degree Norm Column -->
      <ng-container matColumnDef="topology_degree_norm">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Topology Degree (Normalized) </th>
        <td mat-cell *matCellDef="let node">
          <span 
            [style.backgroundColor]="getCriticalityColor(node.topology_degree_norm).bg" 
            [style.color]="getCriticalityColor(node.topology_degree_norm).color" 
            class="chip"
          >
            {{ node.topology_degree_norm?.toFixed(4) }}
          </span>
        </td>
      </ng-container>

      <!-- Topology Betweenness Column -->
      <!-- <ng-container matColumnDef="topology_betweenness">
        <th mat-header-cell *matHeaderCellDef> Topology Betweenness </th> 
        <td mat-cell *matCellDef="let node"> {{ node.topology_betweenness }} </td>
      </ng-container> -->

      <!-- Topology Betweenness Norm Column -->
      <ng-container matColumnDef="topology_betweenness_norm">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Topology Betweenness (Normalized) </th>
        <td mat-cell *matCellDef="let node"> 
          <span [style.backgroundColor]="getCriticalityColor(node.topology_betweenness_norm).bg" 
                [style.color]="getCriticalityColor(node.topology_betweenness_norm).color" class="chip">
            {{ node.topology_betweenness_norm?.toFixed(4) }}
          </span>
        </td>
      </ng-container>

      <!-- Mission Criticality Column -->
      <ng-container matColumnDef="mission_criticality"> 
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Mission Criticality </th>
        <td mat-cell *matCellDef="let node"> 
          <span [style.backgroundColor]="getCriticalityColor(node.mission_criticality).bg" 
                [style.color]="getCriticalityColor(node.mission_criticality).color" class="chip">
            {{ node.mission_criticality?.toFixed(4) }}
          </span>
        </td>
      </ng-container>

      <!-- Final Criticality Column -->
      <ng-container matColumnDef="final_criticality">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Final Criticality </th>
        <td mat-cell *matCellDef="let node"> 
          <span [style.backgroundColor]="getCriticalityColor(node.final_criticality, true).bg" 
                [style.color]="getCriticalityColor(node.final_criticality, true).color" class="chip">
            {{ node.final_criticality?.toFixed(4) }}
          </span>
        </td>
      </ng-container>

      <!-- Table Header and Rows -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      <!-- Row shown when there is no matching data. -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="4">
          <div class="no-data">
            <mat-icon class="no-data-icon">info</mat-icon>
            <div class="no-data-text">No data matching the search term</div>
          </div>
        </td>
      </tr>
    </table>

    <!-- Paginator -->
    <mat-paginator [pageSize]="25" [pageSizeOptions]="[25, 50, 200, 500]" showFirstLastButtons></mat-paginator>
  </ng-container>
  }
</sentinel-card>