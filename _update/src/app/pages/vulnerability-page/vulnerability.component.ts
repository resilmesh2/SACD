import { Component, OnInit, ViewChild, AfterViewInit, ElementRef, ChangeDetectorRef } from '@angular/core';
import { MatTableDataSource, MatTableModule } from '@angular/material/table';
import { MatPaginator, MatPaginatorModule } from '@angular/material/paginator';
import { MatSort, MatSortModule } from '@angular/material/sort';
import { zip } from 'rxjs';
import { ActivatedRoute } from '@angular/router';
import { DataService } from '../../services/data.service';
import { CVE } from '../../models/vulnerability.model';
import { MatFormFieldModule } from '@angular/material/form-field';
import { MatProgressSpinnerModule } from '@angular/material/progress-spinner';
import { MatSelectModule } from '@angular/material/select';
import { MatInputModule } from '@angular/material/input';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { MatIconModule } from '@angular/material/icon';
import { scoreToClassCVSS } from '../../utils/utils';
import { SentinelButtonWithIconComponent } from '@sentinel/components/button-with-icon';
import { CvssScoreChipComponent } from '../../components/cvss-score-chip/cvss-score-chip.component';
import { PieChartModule } from '@swimlane/ngx-charts';

export interface VulnerabilityData {
  ip: string;
  domainName: string;
  subnet: string;
  software: string;
}

@Component({
  selector: 'vulnerability-page',
  templateUrl: './vulnerability.component.html',
  styleUrls: ['./vulnerability.component.scss'],
  imports: [
    MatTableModule,
    MatPaginatorModule,
    MatSortModule,
    MatProgressSpinnerModule,
    MatFormFieldModule,
    MatSelectModule,
    MatFormFieldModule,
    MatInputModule,
    FormsModule,
    ReactiveFormsModule,
    MatIconModule,
    SentinelButtonWithIconComponent,
    CvssScoreChipComponent,
    PieChartModule
  ]
})

export class VulnerabilityPageComponent implements OnInit, AfterViewInit {
  displayedColumns: string[] = ['ip', 'domainName', 'subnet', 'software'];
  cveSearch = 'CVE-2024-22861';
  dataSource: MatTableDataSource<VulnerabilityData>;
  cveDescription: string = "";
  pieChartData: { name: string; value: number }[] = [];
  colorScheme = {
    domain: [
      '#e0f7fa',
      '#b2ebf2',
      '#80deea',
      '#4dd0e1',
      '#26c6da',
      '#00bcd4',
      '#00acc1',
      '#0097a7',
      '#00838f',
      '#006064',
    ],
  };
  @ViewChild(MatPaginator, { static: false }) paginator: MatPaginator | null = null;
  @ViewChild(MatSort, { static: false }) sort: MatSort | null = null;
  cveDetails: CVE | null = null;
  dataLoaded = false;
  dataLoading = false;

  constructor(private data: DataService, private changeDetector: ChangeDetectorRef, private route: ActivatedRoute) {
    this.dataSource = new MatTableDataSource<VulnerabilityData>([]);
    if (route.snapshot.params && route.snapshot.params['cve']) {
      this.cveSearch = route.snapshot.params['cve'];
      this.searchVulnerability();
    }
  }

  emptyResponse = false;
  cveSearched = '';
  errorResponse = '';

  ngOnInit(): void {}

  ngAfterViewInit(): void {}

  searchVulnerability() {
    this.emptyResponse = false;
    this.errorResponse = '';
    this.cveSearched = this.cveSearch;
    this.dataLoading = true;

    const $cveDetails = this.data.getCVEDetails(this.cveSearch.trim());
    const $vulnMachines = this.data.getVulnerableMachines(this.cveSearch.trim());

    zip($cveDetails, $vulnMachines, (cveDetails: CVE, machines: any) => ({ cveDetails, machines })).subscribe(
      (data) => {
        this.dataSource = new MatTableDataSource(data.machines);
        const subnets: { [key: string]: number } = {};
        if (data.machines) {
          data.machines.forEach((row: VulnerabilityData) => {
            if (!subnets[row.subnet]) {
              subnets[row.subnet] = 1;
            } else {
              subnets[row.subnet] += 1;
            }
          });
          const pieChartData: { name: string; value: number }[] = [];
          Object.keys(subnets).map((key) => {
            pieChartData.push({ name: key, value: subnets[key] });
          });

          this.pieChartData = pieChartData;
        }

        if (data.cveDetails) {
          this.cveDescription = data.cveDetails.description;
          this.cveDetails = data.cveDetails;
        }

        if (!data.cveDetails || !data.machines) {
          this.emptyResponse = true;
        }

        this.dataLoading = false;
        this.dataLoaded = true;
        this.changeDetector.detectChanges();

        this.dataSource.sort = this.sort;
        this.dataSource.paginator = this.paginator;
      },
      (error) => {
        this.errorResponse = error;
        this.dataLoading = false;
      }
    );
  }

  filterSubnet(event: { name: string; value: number; label: string }) {
    this.changeDetector.detectChanges();
    this.dataSource.filter = event.name;
    if (this.paginator !== null) {
      this.paginator.firstPage();
    }
  }

  scoreToClassCVSS(score: string, version: number): string {
    return scoreToClassCVSS(score, version);
  }
}
