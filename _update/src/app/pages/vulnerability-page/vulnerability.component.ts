import { Component, OnInit, ViewChild, AfterViewInit, ElementRef, ChangeDetectorRef, inject, signal } from '@angular/core';
import { MatTableDataSource, MatTableModule } from '@angular/material/table';
import { MatPaginator, MatPaginatorModule } from '@angular/material/paginator';
import { MatSort, MatSortModule } from '@angular/material/sort';
import { zip } from 'rxjs';
import { ActivatedRoute, Router } from '@angular/router';
import { DataService } from '../../services/data.service';
import { CVE } from '../../models/vulnerability.model';
import { MatFormFieldModule } from '@angular/material/form-field';
import { MatProgressSpinnerModule } from '@angular/material/progress-spinner';
import { MatSelectModule } from '@angular/material/select';
import { MatInputModule } from '@angular/material/input';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { MatIconModule } from '@angular/material/icon';
import { scoreToClassCVSS } from '../../utils/utils';
import { SentinelButtonWithIconComponent } from '@sentinel/components/button-with-icon';
import { CvssChipComponent } from '../../components/cvss-color-chip/cvss-chip.component';
import { PieChartModule } from '@swimlane/ngx-charts';
import { MatButtonToggleModule } from '@angular/material/button-toggle';
import { CvssReportComponent } from './cvss-report/cvss-report.component';


export interface VulnerabilityData {
  ip: string;
  domainName: string;
  subnet: string;
  software: string;
}

@Component({
  selector: 'vulnerability-page',
  templateUrl: './vulnerability.component.html',
  styleUrls: ['./vulnerability.component.scss'],
  imports: [
    MatTableModule,
    MatPaginatorModule,
    MatSortModule,
    MatProgressSpinnerModule,
    MatFormFieldModule,
    MatSelectModule,
    MatFormFieldModule,
    MatInputModule,
    FormsModule,
    ReactiveFormsModule,
    MatIconModule,
    SentinelButtonWithIconComponent,
    PieChartModule,
    MatButtonToggleModule,
    CvssReportComponent
  ],
})

export class VulnerabilityPageComponent implements OnInit, AfterViewInit {
  displayedColumns: string[] = ['ip', 'domainName', 'subnet', 'software'];
  cveSearch = 'CVE-2025-9103';
  dataSource: MatTableDataSource<VulnerabilityData>;
  pieChartData: { name: string; value: number }[] = [];

  @ViewChild(MatPaginator, { static: false }) paginator: MatPaginator | null = null;
  @ViewChild(MatSort, { static: false }) sort: MatSort | null = null;
  cveDetails: CVE | null = null;
  dataLoaded = false;
  dataLoading = false;

  constructor(private data: DataService, private changeDetector: ChangeDetectorRef, private route: ActivatedRoute) {
    this.dataSource = new MatTableDataSource<VulnerabilityData>([]);
    this.route.queryParams.subscribe(params => {
      if (params['cve']) {
        this.cveSearch = params['cve'];
        this.searchVulnerability();
      }
    });
  }

  emptyResponse = false;
  cveSearched = '';
  errorResponse = '';

  ngOnInit(): void {}

  ngAfterViewInit(): void {}

  searchVulnerability() {
    this.emptyResponse = false;
    this.errorResponse = '';
    this.cveSearched = this.cveSearch;
    this.dataLoading = true;

    const $cveDetails = this.data.getCVEDetails(this.cveSearch.trim());
    const $vulnMachines = this.data.getVulnerableMachines(this.cveSearch.trim());

    zip($cveDetails, $vulnMachines, (cveDetails: CVE, machines: any) => ({ cveDetails, machines })).subscribe({
      next: (data) => {
        this.dataSource = new MatTableDataSource(data.machines);
        const subnets: { [key: string]: number } = {};
        if (data.machines) {
          data.machines.forEach((row: VulnerabilityData) => {
            if (!subnets[row.subnet]) {
              subnets[row.subnet] = 1;
            } else {
              subnets[row.subnet] += 1;
            }
          });
          const pieChartData: { name: string; value: number }[] = [];
          Object.keys(subnets).map((key) => {
            pieChartData.push({ name: key, value: subnets[key] });
          });

          this.pieChartData = pieChartData;
        }

        if (data.cveDetails) {
          this.cveDetails = data.cveDetails;
        }

        if (!data.cveDetails || !data.machines) {
          this.emptyResponse = true;
        }

        this.dataLoading = false;
        this.dataLoaded = true;
        this.changeDetector.detectChanges();

        this.dataSource.sort = this.sort;
        this.dataSource.paginator = this.paginator;
      },
      error: (error) => {
        this.errorResponse = error;
        this.dataLoading = false;
      }
    });
  }

  filterSubnet(event: { name: string; value: number; label: string }) {
    this.changeDetector.detectChanges();
    this.dataSource.filter = event.name;
    if (this.paginator !== null) {
      this.paginator.firstPage();
    }
  }
}
