<h1>Look for vulnerability in your network</h1>
<div class="top-bar">
  <mat-form-field subscriptSizing="dynamic">
    <mat-label>Search vulnerability by CVE code</mat-label>
    <input matInput placeholder="" [(ngModel)]="cveSearch" />
  </mat-form-field>
  <sentinel-button-with-icon
    color="primary" 
    icon="search"
    [disabled]="!cveSearch"
    (click)="searchVulnerability()"
  >
    Search
  </sentinel-button-with-icon>
</div>
@if (dataLoading) {
  <ng-container>
    <mat-spinner></mat-spinner>
  </ng-container>
} @else if (errorResponse) {
  <ng-container>
    <p class="error">
      <strong>Error fetching data from GraphQL API.</strong><br /><span>Error message: {{ errorResponse }}</span>
    </p>
  </ng-container>
} @else if (emptyResponse) {
  <ng-container>
    <p class="no-data">
      <strong>No available data for CVE code "{{ cveSearched }}".</strong>
    </p>
  </ng-container>
} @else if (dataLoaded && !dataLoading && !emptyResponse) {
  <ng-container>
    <!-- Vulnerability info -->
    <div class="section">
      <div>
        <h2>Vulnerability description</h2>
        <p>{{ cveDescription }}</p>
      </div>
      <div class="extra-info">
        <div>
          <strong>Published: </strong>
          <span>{{ cveDetails?.published }}</span>
        </div>
        <div>
          <strong>Impact: </strong>
          <span>{{ cveDetails?.impact }}</span>
        </div>
      </div>

      <div class="cve-details">
        <div>
          <p class="cve-code">
            <strong>Severity:</strong>
            <cvss-score-chip [label]="scoreToClassCVSS(cveDetails?.base_score_v31 ?? '', 3)"></cvss-score-chip>
          </p>
          <p>
            <strong>CVSS v3.1 Base score: </strong>
            <span [class]="scoreToClassCVSS(cveDetails?.base_score_v31 ?? '', 3)" class="score-text">
              {{ cveDetails?.base_score_v31 }}
            </span>
          </p>
          <p>
            <strong>CVSS v3.1 Confidentiality impact: </strong>
            <span class="score-text">{{ cveDetails?.confidentiality_impact_v31 ?? "unknown" }}</span>
          </p>
          <p>
            <strong>CVSS v3.1 Integrity impact: </strong>
            <span class="score-text">{{ cveDetails?.integrity_impact_v31 ?? "unknown" }}</span>
          </p>
          <p>
            <strong>CVSS v3.1 Availability impact: </strong>
            <span class="score-text">{{ cveDetails?.availability_impact_v31 ?? "unknown" }}</span>
          </p>
        </div>
        <div>
          <p>
            <strong>CVSS v3.1 Attack vector: </strong>
            <span class="score-text">{{ cveDetails?.attack_vector_v31 ?? "unknown" }}</span>
          </p>
          <p>
            <strong>CVSS v3.1 Attack complexity: </strong>
            <span class="score-text">{{ cveDetails?.attack_complexity_v31 ?? "unknown" }}</span>
          </p>
          <p>
            <strong>CVSS v3.1 Priviledges required: </strong>
            <span class="score-text">{{ cveDetails?.privileges_required_v31 ?? "unknown" }}</span>
          </p>
          <p>
            <strong>CVSS v3.1 User interaction: </strong>
            <span class="score-text">{{ cveDetails?.user_interaction_v31 ?? "unknown" }}</span>
          </p>
          <p>
            <strong>CVSS v3.1 Scope: </strong>
            <span class="score-text">{{ cveDetails?.scope_v31 ?? "unknown" }}</span>
          </p>
        </div>
      </div>
      <div class="external-links">
        <a target="_blank" [href]="'https://www.cve.org/CVERecord?id=' + cveSearch">
          <sentinel-button-with-icon
            color="primary" 
            icon="open_in_new"
          >
            Show more info on cve.org
          </sentinel-button-with-icon>
        </a>
        <a target="_blank" [href]="'https://nvd.nist.gov/vuln/detail/' + cveSearch">
          <sentinel-button-with-icon
            color="primary" 
            icon="open_in_new"
          >
            Show more info on nvd.nist.gov
          </sentinel-button-with-icon>
        </a>
      </div>
    </div>
    <div class="occurrence-container" style="min-height: 400px">
      <h3>Vulnerability occurrences in subnets</h3>
      <ngx-charts-pie-chart
        #pieChart
        (select)="filterSubnet($event)"
        [labels]="true"
        [legend]="true"
        [results]="pieChartData"
        [animations]="false"
      ></ngx-charts-pie-chart>
    </div>
    <div class="section">
      <h3>List of allowed hosts</h3>
      <!-- Table with results -->
      <table mat-table [dataSource]="dataSource" matSort>
        <!-- IP Address Column -->
        <ng-container matColumnDef="ip">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>IP Address</th>
          <td mat-cell *matCellDef="let row">
            {{ row.ip }}
            <!-- <a [routerLink]="['/asset-visualization', row.ip]"
              ><strong>{{ row.ip }}</strong></a
            > -->
          </td>
        </ng-container>

        <!-- Domain name Column -->
        <ng-container matColumnDef="domainName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Domain name</th>
          <td mat-cell *matCellDef="let row">{{ row.domainName }}</td>
        </ng-container>

        <!-- Subnet Column -->
        <ng-container matColumnDef="subnet">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Subnet</th>
          <td mat-cell *matCellDef="let row">{{ row.subnet }}</td>
        </ng-container>

        <!-- Software Column -->
        <ng-container matColumnDef="software">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Software</th>
          <td mat-cell *matCellDef="let row" [style.color]="row.color">{{ row.software }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

        <!-- Row shown when there is no matching data. -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" colspan="4">No data matching the CVE code "{{ cveSearch }}"</td>
        </tr>
      </table>
      <mat-paginator [pageSize]="25" [pageSizeOptions]="[25, 50, 200, 500]"></mat-paginator>
    </div>
  </ng-container>
}