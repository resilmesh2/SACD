<h1>Assets list</h1>
<sentinel-card [controls]="controls">
    <!-- Show spinner while loading data -->
  @if (dataLoading) {
    <ng-container>
      <mat-spinner></mat-spinner>
    </ng-container>
  } @else if (errorResponse && !dataLoading) {
    <!-- Show error message if there's an error -->
    <ng-container>
      <p class="error">
        <strong>Error fetching data from GraphQL API.</strong><br />
        <span>Error message: {{ errorResponse }}</span>
      </p>
    </ng-container>
  } @else if (emptyResponse && !dataLoading && !errorResponse) {
    <!-- Show no data message if the response is empty -->
    <ng-container>
      <p class="no-data">
        <strong>No available data.</strong>
      </p>
    </ng-container>
  } @else if (dataLoaded && !dataLoading && !emptyResponse) {
  <ng-container class="full-width-table">
    <div class="header">
      <div class="header-line">
        <mat-form-field subscriptSizing="dynamic">
          <input matInput [(ngModel)]="searchTerm" (keyup)="applyIPFilter()" placeholder="Search by asset IP">
        </mat-form-field>
        <div class="total-assets">
          Total Number of Assets: {{ totalSortedAssets() }}
        </div>
      </div>

      <div class="header-line">
        <mat-form-field class="filter-dropdown" subscriptSizing="dynamic">
          <mat-label>Filter by Type</mat-label>
          <mat-select [(value)]="selectedType" (selectionChange)="applySelectFilter($event, filters[3])">
            <mat-option value="All">All</mat-option>
            @for (type of assetTypes(); track type) {
              <mat-option [value]="type">{{ type }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field class="filter-dropdown" subscriptSizing="dynamic">
          <mat-label>Filter by Status</mat-label>
          <mat-select [(value)]="selectedStatus" (selectionChange)="applySelectFilter($event, filters[2])">
            <mat-option value="All">All</mat-option>
            @for (status of statusOptions(); track status) {
              <mat-option [value]="status">{{ status }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field class="filter-dropdown" subscriptSizing="dynamic">
          <mat-label>Filter by Subnets</mat-label>
          <mat-select [(value)]="selectedSubnet" (selectionChange)="applySelectFilter($event, filters[1])">
            <mat-option value="All">All</mat-option>
            @for (subnet of subnets(); track subnet) {
              <mat-option [value]="subnet">{{ subnet }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field class="filter-dropdown" subscriptSizing="dynamic">
          <mat-label>Filter by Tags</mat-label>
          <mat-select [(value)]="selectedTag" (selectionChange)="applySelectFilter($event, filters[0])">
            <mat-option value="All">All</mat-option>
            @for (tag of tags(); track tag) {
              <mat-option [value]="tag">{{ tag }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field subscriptSizing="dynamic">
          <mat-label>Enter a date range</mat-label>
          <mat-date-range-input [rangePicker]="picker">
            <input matStartDate placeholder="Start date" [(ngModel)]="startDate">
            <input matEndDate placeholder="End date" [(ngModel)]="endDate">
          </mat-date-range-input>
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-date-range-picker #picker></mat-date-range-picker>
        </mat-form-field>
        <mat-date-range-picker #picker></mat-date-range-picker>

        <sentinel-button-with-icon
          color="primary"
          icon="filter_list_off"
          tooltip="Reset all filters"
          (click)="resetFilters()"
        >
          Reset Filters
        </sentinel-button-with-icon>
      </div>
    </div>

    <table mat-table [dataSource]="dataSource" class="mat-table" matSort>
      <!-- IP Column -->
      <ng-container matColumnDef="ip">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> IP </th>
        <td mat-cell *matCellDef="let asset" style="width: 14rem;">
          <a (click)="navigateToNetworkNodeView(asset)" class="asset-link">
            {{ asset.ip }}
          </a>
        </td>
      </ng-container>

      <!-- Type Column -->
      <ng-container matColumnDef="type">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Type </th>
        <td mat-cell *matCellDef="let asset"> 
          <asset-type-chip [label]="asset.type" class="badge"></asset-type-chip>
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
        <td mat-cell *matCellDef="let asset">
          <asset-status-edit-chip 
            [address]="asset.ip" 
            [type]="asset.type" 
            [serviceData]="asset.service_data"
            [(label)]="asset.status" 
            [(isEditOpen)]="asset.isEditOpen" 
            class="badge">
          </asset-status-edit-chip>
        </td>
      </ng-container>

      <!-- Service Column -->
      <ng-container matColumnDef="service">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Service </th>
        <td mat-cell *matCellDef="let asset" style="width: 14rem;">
          <a class="asset-link">
            {{ asset.service ?? '---' }}
          </a>
        </td>
      </ng-container>

      <!-- Subnet Column -->
      <ng-container matColumnDef="subnet">
        <th mat-header-cell *matHeaderCellDef> Subnet </th>
        <td mat-cell *matCellDef="let asset">
          @if (asset.subnet && asset.subnet.length > 0) {
            <!-- If subnet is available, navigate to subnet detail -->
            <a (click)="navigateToSubnetDetail(asset.subnet[0] ?? '')" class="asset-link">
              {{ asset.subnet }}
            </a>
          } @else {
            <!-- If no subnet, display 'No Subnet' -->
            <span class="no-subnet">---</span>
          }
        </td>
      </ng-container>

      <!-- Tag Column -->
      <ng-container matColumnDef="tag">
        <th mat-header-cell *matHeaderCellDef> Tag </th>
        <td mat-cell *matCellDef="let asset"> 
          <tag-component 
            [id]="asset.name"
            [inputTags]="asset.tag"
            [onSubmit]="saveData.bind(this)"
            [allTags]="tags()"
          />
        </td>
      </ng-container>

      <!-- Last Seen Date Column -->
      <ng-container matColumnDef="last_seen">
        <th mat-header-cell *matHeaderCellDef> Last Seen </th>
        <td mat-cell *matCellDef="let asset"> {{ asset.last_seen | date:'yyyy/MM/dd\'T\'HH:mm:ss' }} </td>
      </ng-container>

      <!-- Table Header and Rows -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      <!-- Row shown when there is no matching data. -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="4">
          <div class="no-data">
            <mat-icon class="no-data-icon">info</mat-icon>
            <div class="no-data-text">No data matching the search term</div>
          </div>
        </td>
      </tr>
    </table>

    <!-- Paginator -->
    <mat-paginator [pageSize]="25" [pageSizeOptions]="[25, 50, 200, 500]" showFirstLastButtons></mat-paginator>
  </ng-container>
  }
</sentinel-card>